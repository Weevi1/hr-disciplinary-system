rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // USER AUTHENTICATION HELPERS
    // ===================================

    function isAuthenticated() {
      return request.auth != null;
    }

   function getUserRole() {
  // Get user role from Firebase Auth custom claims
  // Supports both minimal format (r) and legacy format (role) for backward compatibility
  return request.auth != null
    ? (request.auth.token.r != null ? request.auth.token.r :
       (request.auth.token.role != null ? request.auth.token.role : 'guest'))
    : 'guest';
}

    function getUserOrgId() {
      // Get user organization ID from Firebase Auth custom claims
      // Supports both minimal format (org) and legacy format (organizationId) for backward compatibility
      return request.auth != null
        ? (request.auth.token.org != null ? request.auth.token.org :
           (request.auth.token.organizationId != null ? request.auth.token.organizationId : null))
        : null;
    }

    function isSuperUser() {
      return isAuthenticated() && getUserRole() == 'super-user';
    }

    function isReseller() {
      return isAuthenticated() && getUserRole() == 'reseller';
    }

    function isExecutiveManagement() {
      return isAuthenticated() && getUserRole() == 'executive-management';
    }

    function isHRManager() {
      return isAuthenticated() && getUserRole() in ['executive-management', 'hr-manager'];
    }

    function isManager() {
      return isAuthenticated() && getUserRole() in ['executive-management', 'hr-manager', 'hod-manager', 'department-manager'];
    }

    function belongsToOrganization(orgId) {
      return isAuthenticated() && getUserOrgId() == orgId;
    }

    function resellerManagesOrganization(orgId) {
      // Check if current user is a reseller who manages this organization
      // Resellers have custom claim 'res' with their resellerId (e.g., 'reseller_1761284938413')
      // We compare organization's resellerId field against the 'res' custom claim, NOT the auth UID
      // For new organizations being created, we check the incoming data instead
      return isReseller() && (
        (exists(/databases/$(database)/documents/organizations/$(orgId)) &&
         get(/databases/$(database)/documents/organizations/$(orgId)).data.resellerId == request.auth.token.res) ||
        // Allow during organization creation - check if org doc is being created with matching resellerId
        (!exists(/databases/$(database)/documents/organizations/$(orgId)) &&
         request.auth.token.res != null)
      );
    }

    // ===================================
    // CONSOLIDATED PERMISSION HELPERS
    // ===================================

    // Common read permission pattern for organization-scoped data
    function canReadOrgData(orgId) {
      return isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(orgId) ||
        resellerManagesOrganization(orgId)
      );
    }

    // Common write permission pattern for HR-managed data
    function canManageOrgData(orgId) {
      return isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(orgId) && isHRManager()) ||
        resellerManagesOrganization(orgId)
      );
    }

    // Permission for manager-level operations
    function canManagerAccess(orgId) {
      return isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(orgId) && isManager())
      );
    }

    // Permission for reseller creation during deployment
    function canResellerCreate(orgId) {
      return isReseller() && resource == null;
    }

    // ===================================
    // CORE COLLECTIONS
    // ===================================

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperUser() ||
        (isExecutiveManagement() && (
          (resource != null && belongsToOrganization(resource.data.organizationId)) ||
          (resource == null && request.resource.data.organizationId != null)
        )) ||
        // Allow super-user to create reseller users (they don't have organizationId)
        (isSuperUser() && resource == null && request.resource.data.role == 'reseller')
      );
    }

    // UserOrgIndex collection - for scalable O(1) user-organization mapping
    match /userOrgIndex/{userId} {
      // Allow users to read their own index entry for authentication
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperUser()
      );
      // Allow system services to maintain the index
      allow write: if isAuthenticated();
    }

    // Organizations collection
    match /organizations/{organizationId} {
      // Super-users and resellers need to list organizations for dashboard
      allow list: if isAuthenticated() && (isSuperUser() || isReseller());

      // Individual organization access
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      // Full write access for super-users, executive management, and resellers
      allow create, delete: if isAuthenticated() && (
        isSuperUser() ||
        (isExecutiveManagement() && belongsToOrganization(organizationId)) ||
        isReseller()  // Resellers can create and manage organizations
      );

      // Allow HR managers to update only setupSkipped field (for dashboard onboarding)
      allow update: if isAuthenticated() && (
        isSuperUser() ||
        (isExecutiveManagement() && belongsToOrganization(organizationId)) ||
        isReseller() ||
        // HR managers can only update setupSkipped field
        (isHRManager() && belongsToOrganization(organizationId) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['setupSkipped']))
      );
    }

    // Employees collection
    match /employees {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /employees/{employeeId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(resource.data.organizationId) ||
        resellerManagesOrganization(resource.data.organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(
          resource == null ? request.resource.data.organizationId : resource.data.organizationId
        ))
      );
    }

    // ===================================
    // DEPRECATED GLOBAL COLLECTIONS
    // ===================================
    // NOTE: These collections are deprecated in favor of sharded versions under organizations/{orgId}/
    // Kept for backward compatibility with read-only access for super-users during migration
    // Migration target: organizations/{orgId}/warnings/{warningId}

    // Warnings collection - DEPRECATED (use organizations/{orgId}/warnings instead)
    match /warnings {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /warnings/{warningId} {
      // Read-only for super-users during migration period
      allow read: if isAuthenticated() && isSuperUser();
      // Write restricted to super-users only for data migration
      allow write: if isAuthenticated() && isSuperUser();
    }

    // ===================================
    // ðŸ†• HR MEETING REQUESTS COLLECTION
    // ===================================

    // HR meeting requests - managers can create, HR can read/update
    match /hr_meeting_requests {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /hr_meeting_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(resource.data.organizationId) && (
          // Manager who created the request
          request.auth.uid == resource.data.managerId ||
          // HR managers can see all requests in their org
          isHRManager() ||
          // Business owners can see all requests in their org
          isExecutiveManagement()
        ))
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() &&
         belongsToOrganization(request.resource.data.organizationId) &&
         request.auth.uid == request.resource.data.managerId)
      );

      allow update: if isAuthenticated() && (
        isSuperUser() ||
        // Original manager can update their own request
        (request.auth.uid == resource.data.managerId &&
         belongsToOrganization(resource.data.organizationId)) ||
        // HR can update any request in their organization (for scheduling, notes, etc.)
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      // Only super users can delete meeting requests
      allow delete: if isAuthenticated() && isSuperUser();
    }

    // ===================================
    // ðŸ†• ABSENCE REPORTS COLLECTION
    // ===================================

    // Absence reports - managers can create, HR can read/update
    match /absence_reports {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /absence_reports/{reportId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(resource.data.organizationId) && (
          // Manager who created the report
          request.auth.uid == resource.data.managerId ||
          // HR managers can see all reports in their org
          isHRManager() ||
          // Business owners can see all reports in their org
          isExecutiveManagement()
        ))
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() &&
         belongsToOrganization(request.resource.data.organizationId) &&
         request.auth.uid == request.resource.data.managerId)
      );

      allow update: if isAuthenticated() && (
        isSuperUser() ||
        // Original manager can update their own report
        (request.auth.uid == resource.data.managerId &&
         belongsToOrganization(resource.data.organizationId)) ||
        // HR can update any report in their organization (for review, notes, etc.)
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      // Only super users can delete absence reports
      allow delete: if isAuthenticated() && isSuperUser();
    }

    // ===================================
    // SECTOR SYSTEM COLLECTIONS
    // ===================================

    // Sectors collection - read-only for most users, write for super users only
    match /sectors/{sectorId} {
      allow read: if isAuthenticated();

      allow write: if isAuthenticated() && isSuperUser();
    }

    // Organization sectors configuration - organization specific access
    match /organizationSectors/{organizationId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(organizationId))
      );
    }

    // ===================================
    // WARNING CATEGORIES & ESCALATION
    // ===================================

    // Warning categories - DEPRECATED (use organizations/{orgId}/categories instead)
    // Migration target: organizations/{orgId}/categories/{categoryId}
    match /warningCategories {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /warningCategories/{categoryId} {
      // Read-only for existing users during migration
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(resource.data.organizationId) && isManager())
      );

      // Write restricted to super-users only for data migration
      allow write: if isAuthenticated() && isSuperUser();
    }

    // Escalation rules - organization specific
    match /escalationRules/{ruleId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(resource.data.organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // DOCUMENT MANAGEMENT
    // ===================================

    // Document captures - organization specific
    match /documentCaptures/{captureId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(resource.data.organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // Document templates - organization specific
    match /documentTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(resource.data.organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // DELIVERY SYSTEM
    // ===================================

    // Delivery preferences - employee and HR access
    match /deliveryPreferences/{employeeId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId)) ||
        request.auth.uid == resource.data.userId
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId)) ||
        request.auth.uid == resource.data.userId
      );
    }

    // Delivery logs - organization specific
    match /deliveryLogs/{logId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // Delivery notifications - organization specific
    match /deliveryNotifications/{notificationId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(request.resource.data.organizationId))
      );

      allow update, delete: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // ðŸ“‹ CORRECTIVE COUNSELLING - DEPRECATED (MERGED INTO WARNINGS)
    // ===================================
    // NOTE: As of Session 48, corrective counselling has been merged into the warnings system.
    // Counselling data is now stored as optional fields within warning documents:
    // - counsellingDetails (object with expectedBehavior, actionSteps, reviewDate)
    // - counsellingType (optional: 'informal' | 'corrective')
    // - isCounselling (boolean flag)
    //
    // Historical counselling records remain accessible via super-user for data migration/archival purposes.
    // No new counselling records should be created in these standalone collections.

    // DEPRECATED: Global corrective_counselling collection (read-only for super-users)
    match /corrective_counselling {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /corrective_counselling/{counsellingId} {
      // Read-only access for super-users (data migration/archival only)
      allow read: if isAuthenticated() && isSuperUser();
      // No writes allowed - use warnings collection instead
      allow create, update, delete: if false;
    }

    // DEPRECATED: Counselling follow-up records (read-only for super-users)
    match /counselling_followups/{followUpId} {
      // Read-only access for super-users (data migration/archival only)
      allow read: if isAuthenticated() && isSuperUser();
      // No writes allowed - counselling is now part of warnings
      allow create, update, delete: if false;
    }

    // ===================================
    // ðŸ”” NOTIFICATIONS COLLECTION
    // ===================================

    // User notifications - users can read/update their own notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        // Users can read their own notifications
        request.auth.uid == resource.data.userId ||
        // HR can read notifications for their organization
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        // System can create notifications for any user in the organization
        (isManager() && belongsToOrganization(request.resource.data.organizationId)) ||
        // Allow notifications to be created for the current user
        request.auth.uid == request.resource.data.userId
      );

      allow update: if isAuthenticated() && (
        isSuperUser() ||
        // Users can update their own notifications (mark as read)
        request.auth.uid == resource.data.userId ||
        // HR can update notifications in their organization
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow delete: if isAuthenticated() && (
        isSuperUser() ||
        // Users can delete their own notifications
        request.auth.uid == resource.data.userId ||
        // HR can delete notifications in their organization
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // AI ESCALATION SYSTEM
    // ===================================

    // Escalation recommendations - organization specific
    match /escalationRecommendations/{recommendationId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(resource.data.organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // Employee risk profiles - HR access only
    match /employeeRiskProfiles/{employeeId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // ANALYTICS AND REPORTING
    // ===================================

    // Analytics collection - restricted access
    match /analytics/{document} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        isExecutiveManagement()
      );

      allow write: if isAuthenticated() && isSuperUser();
    }

    // Audit logs - organization specific reading, managers can write
    match /auditLogs {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /auditLogs/{logId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (isHRManager() && belongsToOrganization(resource.data.organizationId))
      );

      // Managers can write audit logs for their organization
      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (isManager() && belongsToOrganization(
          resource == null ? request.resource.data.organizationId : resource.data.organizationId
        ))
      );
    }

    // ===================================
    // SHARDED ORGANIZATION COLLECTIONS
    // ===================================

    // Sharded users collection - within organization context
    match /organizations/{organizationId}/users/{userId} {
      // Allow list/query for managers to see user listings in their org
      allow list: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager()) ||
        resellerManagesOrganization(organizationId)
      );

      allow read: if isAuthenticated() && (
        isSuperUser() ||
        request.auth.uid == userId ||
        (belongsToOrganization(organizationId) && isManager()) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        request.auth.uid == userId ||
        (belongsToOrganization(organizationId) && isExecutiveManagement()) ||
        // Allow HR managers to update user department assignments and manager-related fields
        (belongsToOrganization(organizationId) && isHRManager()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // Sharded employees collection
    match /organizations/{organizationId}/employees/{employeeId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Sharded categories collection
    match /organizations/{organizationId}/categories/{categoryId} {
      // Allow list and get for authenticated users who can access the org
      allow list, get: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow create, update, delete: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isHRManager()) ||
        resellerManagesOrganization(organizationId)
      );
    }

    // Sharded sectors collection
    match /organizations/{organizationId}/sectors/{sectorId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isHRManager()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // Sharded warnings collection
    // NOTE: As of Session 48, this collection includes corrective counselling data as optional fields:
    // - counsellingDetails (object with expectedBehavior, actionSteps, reviewDate)
    // - counsellingType (optional: 'informal' | 'corrective')
    // - isCounselling (boolean flag)
    // All new counselling records are stored here, not in separate corrective_counselling collections.
    //
    // REVIEW TRACKING FIELDS (Session 48):
    // Managers (including HR) can update review status and follow-up tracking fields:
    // - reviewStatus, reviewCompletedDate, reviewCompletedBy, reviewCompletedByName
    // - reviewHODFeedback, reviewHRNotes, reviewOutcome, reviewNextSteps
    // - autoSatisfiedDate, escalatedToWarningId, reviewLastChecked
    match /organizations/{organizationId}/warnings/{warningId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // PDF Template Versions collection - for efficient template storage
    // Stores template versions separately to avoid duplicating 5-10KB of data with every warning
    match /organizations/{organizationId}/pdfTemplateVersions/{version} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Sharded delivery notifications collection
    match /organizations/{organizationId}/deliveryNotifications/{notificationId} {
      allow read, write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager()) ||
        // Allow HR managers to read delivery notifications
        (belongsToOrganization(organizationId) && isHRManager())
      );
    }

    // Sharded escalation rules collection
    match /organizations/{organizationId}/escalationRules/{ruleId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isHRManager()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // Sharded settings collection
    match /organizations/{organizationId}/settings/{settingId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isExecutiveManagement()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // Sharded meetings collection
    match /organizations/{organizationId}/meetings/{meetingId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Sharded departments collection
    match /organizations/{organizationId}/departments/{departmentId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isHRManager()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // Sharded reports collection - ABSENCE REPORTS ONLY
    // NOTE: This collection now stores only absence reports.
    // Counselling reports are deprecated and merged into the warnings system.
    match /organizations/{organizationId}/reports/{reportId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Sharded collection metadata documents
    match /organizations/{organizationId}/{collection}/_metadata {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isExecutiveManagement()) ||
        resellerManagesOrganization(organizationId) ||
        (isReseller() && resource == null)  // Allow resellers to create during deployment
      );
    }

    // ===================================
    // BILLING AND COMMISSION SYSTEM
    // ===================================

    // Resellers collection - allow reading/listing for super users and resellers
    match /resellers {
      allow read: if isAuthenticated() && (isSuperUser() || isReseller());
    }

    // Resellers collection - super user and reseller read access
    match /resellers/{resellerId} {
      // Resellers can read all reseller profiles (needed for client deployment wizard)
      allow read: if isAuthenticated() && (isSuperUser() || isReseller());
      allow write: if isAuthenticated() && isSuperUser();
    }

    // Commissions collection - super user and reseller read access
    match /commissions/{commissionId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        // Resellers can read commissions for organizations they manage
        (isReseller() && resource.data.resellerId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.resellerId)
      );
      allow write: if isAuthenticated() && isSuperUser();
    }

    // Commission reports collection - super user and reseller access
    match /commissionReports/{reportId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        // Resellers can read their own commission reports
        (isReseller() && request.auth.uid == resource.data.resellerId)
      );
      allow write: if isAuthenticated() && isSuperUser();
    }

    // Subscriptions collection - super user only
    match /subscriptions/{subscriptionId} {
      allow read, write: if isAuthenticated() && isSuperUser();
    }

    // Reseller deployments collection - resellers can read their own deployments
    match /resellerDeployments {
      allow list: if isAuthenticated() && isSuperUser();
    }

    match /resellerDeployments/{deploymentId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        // Resellers can read their own deployments
        (isReseller() && request.auth.uid == resource.data.resellerId)
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        // Resellers can create their own deployment records
        (isReseller() && request.auth.uid == request.resource.data.resellerId)
      );

      allow update, delete: if isAuthenticated() && (
        isSuperUser() ||
        // Resellers can update their own deployments
        (isReseller() && request.auth.uid == resource.data.resellerId)
      );
    }

    // ===================================
    // SYSTEM CONFIGURATION
    // ===================================

    // System configuration - super user only
    match /systemConfig/{configId} {
      allow read, write: if isAuthenticated() && isSuperUser();
    }

    // System logs - super user only
    match /systemLogs/{logId} {
      allow read, write: if isAuthenticated() && isSuperUser();
    }

    // ===================================
    // ðŸ†• SHARDED ORGANIZATION COLLECTIONS - CORRECTIVE COUNSELLING (DEPRECATED)
    // ===================================
    // NOTE: Counselling is now merged into the warnings system.
    // Keeping this collection for historical data access only (read-only for super-users).

    match /organizations/{organizationId}/corrective_counselling/{counsellingId} {
      // Read-only access for super-users (data migration/archival only)
      allow read: if isAuthenticated() && isSuperUser();
      // No writes allowed - counselling is now part of warnings
      allow create, update, delete: if false;
    }

    // ===================================
    // NESTED DATA STRUCTURE RULES
    // ===================================

    // Employee subcollections - nested under employees
    match /organizations/{organizationId}/employees/{employeeId}/warnings/{warningId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId) ||
        resellerManagesOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    match /organizations/{organizationId}/employees/{employeeId}/meetings/{meetingId} {
      allow read, list, write: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );
    }

    match /organizations/{organizationId}/employees/{employeeId}/absences/{absenceId} {
      allow read, list, write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Employee summary documents
    match /organizations/{organizationId}/employees/{employeeId}/summary/{document} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Index collections for fast queries
    match /organizations/{organizationId}/indexes/activeWarnings/{entryId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    match /organizations/{organizationId}/indexes/upcomingMeetings/{entryId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    match /organizations/{organizationId}/indexes/recentAbsences/{entryId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        belongsToOrganization(organizationId)
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );
    }

    // Analytics and summary documents
    match /organizations/{organizationId}/analytics/{document} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isManager())
      );

      allow write: if isAuthenticated() && (
        isSuperUser() ||
        (belongsToOrganization(organizationId) && isHRManager())
      );
    }

    // Collection group queries - need special rules
    match /{path=**}/warnings/{warningId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        // Allow collection group queries if user belongs to the organization
        resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)
      );
    }

    match /{path=**}/meetings/{meetingId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)
      );
    }

    match /{path=**}/absences/{absenceId} {
      allow read, list: if isAuthenticated() && (
        isSuperUser() ||
        resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)
      );
    }

    // NOTE: The following collections are already defined earlier in the file:
    // - employees (lines ~163-176) - global collection rules
    // - warningCategories (lines ~303-317) - global collection rules
    // - absenceReports (lines ~236-272) - global collection rules
    // - auditLogs (lines ~553-566) - global collection rules
    // Redundant duplicate rules removed to prevent conflicts

    // ===================================
    // SUPER-USER SPECIFIC COLLECTIONS
    // ===================================

    // PII Access Logs - for compliance and audit tracking
    match /piiAccessLogs/{logId} {
      allow read: if isAuthenticated() && isSuperUser();
      // Allow super-users and managers to log PII access
      allow create: if isAuthenticated() && (isSuperUser() || isManager());
      // PII logs are immutable once created
      allow update, delete: if false;
    }

    // Super-user session management
    match /superUserSessions/{sessionId} {
      allow read: if isAuthenticated() && isSuperUser() &&
        request.auth.uid == resource.data.userId;
      allow create, update: if isAuthenticated() && isSuperUser() &&
        request.auth.uid == request.resource.data.userId;
      allow delete: if isAuthenticated() && isSuperUser();
    }

    // Super-user security events (failed logins, privilege escalations, etc.)
    match /securityEvents/{eventId} {
      allow read: if isAuthenticated() && isSuperUser();
      // Security events are created by Cloud Functions only
      allow create: if false;
      allow update, delete: if false;
    }

    // System configuration (only super-users can modify)
    match /systemConfig/{configId} {
      allow read: if isAuthenticated() && isSuperUser();
      allow write: if isAuthenticated() && isSuperUser();
    }

    // NOTE: commissionReports rules are defined earlier in BILLING section (lines ~766-773)
    // Duplicate removed to prevent rule conflicts

    // Global metrics and analytics (super-user only)
    match /globalMetrics/{metricId} {
      allow read, write: if isAuthenticated() && isSuperUser();
    }

    // ===================================
    // TEMPORARY FILES FOR QR CODE CLEANUP
    // ===================================

    // Temporary files collection - for tracking QR code PDFs that need cleanup
    // Managers create entries when generating QR codes, system cleans up expired files
    match /temporaryFiles/{fileId} {
      allow read: if isAuthenticated() && (
        isSuperUser() ||
        // Managers can read temporary file records for their organization
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );

      allow create: if isAuthenticated() && (
        isSuperUser() ||
        // Managers can create temporary file tracking records
        (isManager() && belongsToOrganization(request.resource.data.organizationId))
      );

      allow update, delete: if isAuthenticated() && (
        isSuperUser() ||
        // System/managers can update status or delete expired entries
        (isManager() && belongsToOrganization(resource.data.organizationId))
      );
    }

    // ===================================
    // ENHANCED SECURITY HELPERS
    // ===================================

    function isSuperUserPermission() {
      // Enhanced super-user check with permissions validation
      // Used in fallback rule to ensure super-users have proper permission claims
      return request.auth != null &&
        request.auth.token.role == 'super-user' &&
        request.auth.token.permissions != null &&
        ('all' in request.auth.token.permissions || 'super-admin' in request.auth.token.permissions);
    }

    // ===================================
    // FALLBACK RULE
    // ===================================

    // Super users get full access to any collection not explicitly defined above
    // But with session validation for sensitive operations
    match /{document=**} {
      allow read: if isAuthenticated() && isSuperUser();
      allow write: if isAuthenticated() && isSuperUserPermission();
    }
  }
}
