const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/EmployeeLifecycleService-rnUWPbok.js","assets/pdf-vendor-CbrIsI36.js","assets/react-vendor-BMk1H4su.js","assets/firebase-vendor-BIBOIkWK.js","assets/ui-vendor-DjDr2yFV.js","assets/OrganizationManagementV2-6W0PK7yr.js","assets/hr-dashboard-DCNKcWEX.js","assets/dashboard-router-DriKLXjX.js","assets/hod-dashboard-BWpKy7JX.js","assets/OverviewCard-D4wI38Zf.js","assets/EmployeeManagement-PJFEvAf-.js","assets/employee-BVTMyN2H.js","assets/warning-components-D4Kh8JfB.js","assets/DepartmentManagement-DUiAX536.js","assets/FinalWarningsWatchList-FlCXsP7W.js"])))=>i.map(i=>d[i]);
import{a as e}from"./pdf-vendor-CbrIsI36.js";import{a as t,r as a,R as r}from"./react-vendor-BMk1H4su.js";import{i,g as n,a as o,b as s,c,d as l,e as d,s as u,f as g,h as m,o as p,j as h,k as y,l as w,q as v,m as f,n as D,p as E,u as A,r as b,w as S,t as x,v as I,F as C,x as z,y as N,z as R,A as O,T as _,B as T}from"./firebase-vendor-BIBOIkWK.js";import{C as $,U as k,T as P,S as L,B as W,a as F}from"./ui-vendor-DjDr2yFV.js";var j,U,M={exports:{}},B={};var H=(U||(U=1,M.exports=function(){if(j)return B;j=1;var e=t(),a=Symbol.for("react.element"),r=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,n=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function s(e,t,r){var s,c={},l=null,d=null;for(s in void 0!==r&&(l=""+r),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)i.call(t,s)&&!o.hasOwnProperty(s)&&(c[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===c[s]&&(c[s]=t[s]);return{$$typeof:a,type:e,key:l,ref:d,props:c,_owner:n.current}}return B.Fragment=r,B.jsx=s,B.jsxs=s,B}()),M.exports);class V{static{this.productionWhitelist=["‚ùå","üö®","‚ö†Ô∏è","‚úÖ","üéØ"]}static debug(e,t,a){}static info(e,t,a){this.isWhitelistedMessage(e)&&console.info(this.formatMessage("INFO",e,a),t)}static warn(e,t,a){const r=this.sanitizeData(t);console.warn(this.formatMessage("WARN",e,a),r)}static error(e,t,a){const r=this.sanitizeError(t);console.error(this.formatMessage("ERROR",e,a),r),this.sendToMonitoring("error",e,r,a)}static success(e,t,a){const r=String(e);this.isWhitelistedMessage(e)&&console.log(this.formatMessage("SUCCESS",r,a),t)}static perf(e,t,a){}static isWhitelistedMessage(e){const t=String(e);return this.productionWhitelist.some(e=>t.startsWith(e))}static formatMessage(e,t,a){return`[${(new Date).toISOString()}] ${e}: ${t}${a?this.formatContext(a):""}`}static formatContext(e){const t=[];return e.organizationId&&t.push(`org:${e.organizationId.slice(-8)}`),e.userId&&t.push(`user:${e.userId.slice(-8)}`),e.component&&t.push(`comp:${e.component}`),e.action&&t.push(`action:${e.action}`),t.length>0?` [${t.join(", ")}]`:""}static sanitizeData(e){if(!e)return e;if("string"==typeof e)return this.sanitizeString(e);if("object"==typeof e){const t={};for(const[a,r]of Object.entries(e))this.isSensitiveKey(a)?t[a]="[REDACTED]":t[a]="object"==typeof r?this.sanitizeData(r):r;return t}return e}static sanitizeError(e){return e?e instanceof Error?{name:e.name,message:this.sanitizeString(e.message),stack:"[REDACTED]"}:this.sanitizeData(e):e}static isSensitiveKey(e){const t=e.toLowerCase();return["password","token","secret","key","auth","credential","email","phone","address","ssn","id_number","passport","salary","wage","bank","account","credit","personal","medical","health","disciplinary","performance"].some(e=>t.includes(e))}static sanitizeString(e){return e&&"string"==typeof e?e=(e=(e=(e=e.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,"[EMAIL]")).replace(/(\+27|0)[6-8][0-9]{8}/g,"[PHONE]")).replace(/\b\d{13}\b/g,"[ID_NUMBER]")).replace(/\b[a-zA-Z0-9]{20,}\b/g,"[TOKEN]"):e}static sendToMonitoring(e,t,a,r){try{const i={level:e,message:t,data:a,context:r,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href},n=JSON.parse(localStorage.getItem("hr_production_errors")||"[]");n.push(i),n.length>20&&n.shift(),localStorage.setItem("hr_production_errors",JSON.stringify(n))}catch(i){}}static getProductionLogs(){try{return JSON.parse(localStorage.getItem("hr_production_errors")||"[]")}catch{return[]}}static clearProductionLogs(){localStorage.removeItem("hr_production_errors")}}V.debug.bind(V),V.info.bind(V),V.warn.bind(V),V.error.bind(V),V.success.bind(V),V.perf.bind(V);const q=i({apiKey:"AIzaSyCghheyHpRDcc-2sue-u1apExJr6jQCzyw",authDomain:"hr-disciplinary-system.firebaseapp.com",projectId:"hr-disciplinary-system",storageBucket:"hr-disciplinary-system.firebasestorage.app",messagingSenderId:"989741369966",appId:"1:989741369966:web:e388dc78d75744d828747f",measurementId:void 0}),G=n(q),K=o(q),Z=s(q),Y=c(q,"us-central1");l(q),d(K).then(()=>{}).catch(e=>{V.error("Failed to enable Firestore network:",e)});const Q=Object.freeze(Object.defineProperty({__proto__:null,app:q,auth:G,db:K,functions:Y,storage:Z},Symbol.toStringTag,{value:"Module"}));const J=new class{constructor(){this.isCreatingUser=!1,this.pendingUserIds=new Set}startUserCreation(e){this.isCreatingUser=!0,this.pendingUserIds.add(e)}finishUserCreation(e){this.pendingUserIds.delete(e),0===this.pendingUserIds.size&&(this.isCreatingUser=!1)}isCreating(){return this.isCreatingUser}isPendingUser(e){return this.pendingUserIds.has(e)}};class X extends Error{constructor(e,t,a){super(e),this.code=t,this.originalError=a,this.name="FirebaseServiceError"}}class ee{static handle(e,t){if(V.error(`[FirebaseService] ${t} failed`,e),e instanceof C)throw new X(`Firestore error during ${t}: ${e.message}`,e.code,e);if(e&&"object"==typeof e&&"code"in e&&"message"in e)throw new X(`Auth error during ${t}: ${e.message}`,e.code,e);throw new X(`Unknown error during ${t}`,"unknown",e)}}class te{static async signIn(e,t){try{const a=await u(G,e,t);return a.user.uid,a.user}catch(a){ee.handle(a,"signIn")}}static async signUp(e,t){try{const a=await g(G,e,t);return a.user.uid,a.user}catch(a){ee.handle(a,"signUp")}}static async signOut(){try{await m(G)}catch(e){ee.handle(e,"signOut")}}static onAuthStateChanged(e){return p(G,e)}static async getDocument(e,t){try{const a=h(K,e,t),r=await y(a);return r.exists()?{id:r.id,...r.data()}:(J.isPendingUser(t)||J.isCreating()||V.warn("Document not found",{collection:e,id:t}),null)}catch(a){ee.handle(a,`getDocument(${e}/${t})`)}}static async getCollection(e,t){try{const a=w(K,e);let r=t?v(a,...t):a;const i=(await f(r)).docs.map(e=>({id:e.id,...e.data()}));return i.length,i}catch(a){ee.handle(a,`getCollection(${e})`)}}static async createDocument(e,t,a){try{const r=a||h(w(K,e)).id,i=h(K,e,r),{id:n,...o}=t;return await D(i,{...o,createdAt:E(),updatedAt:E()}),r}catch(r){ee.handle(r,`createDocument(${e})`)}}static async setDocument(e,t,a){try{const r=h(K,e,t);await D(r,a)}catch(r){ee.handle(r,`setDocument(${e}/${t})`)}}static async updateDocument(e,t,a){try{const r=h(K,e,t);await A(r,{...a,updatedAt:E()})}catch(r){ee.handle(r,`updateDocument(${e}/${t})`)}}static async deleteDocument(e,t){try{const a=h(K,e,t);await b(a)}catch(a){ee.handle(a,`deleteDocument(${e}/${t})`)}}static async queryDocuments(e,t,a,r){try{t.length;const i=t.map(e=>S(e.field,e.operator,e.value));return a&&i.push(x(a)),r&&i.push(I(r)),await this.getCollection(e,i)}catch(i){ee.handle(i,`queryDocuments(${e})`)}}static async batchCreate(e,t){try{t.length;const a=[];for(let r=0;r<t.length;r+=10){const i=t.slice(r,r+10).map(t=>this.createDocument(e,t)),n=await Promise.all(i);a.push(...n)}return a.length,a}catch(a){ee.handle(a,`batchCreate(${e})`)}}static async refreshUserClaims(t){try{const{getFunctions:a,httpsCallable:r}=await e(async()=>{const{getFunctions:e,httpsCallable:t}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Z);return{getFunctions:e,httpsCallable:t}},[]),i=r(a(),"refreshUserClaims"),n=await i({targetUserId:t});return n.data,n.data}catch(a){throw V.error("Failed to refresh custom claims:",a),new X("Failed to refresh custom claims","refresh-claims-failed",a)}}static async refreshOrganizationUserClaims(t){try{const{getFunctions:a,httpsCallable:r}=await e(async()=>{const{getFunctions:e,httpsCallable:t}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Z);return{getFunctions:e,httpsCallable:t}},[]),i=r(a(),"refreshOrganizationUserClaims"),n=await i({organizationId:t});return n.data,n.data}catch(a){throw V.error("Failed to refresh organization claims:",a),new X("Failed to refresh organization claims","refresh-org-claims-failed",a)}}static async getUserClaims(){try{const{getFunctions:t,httpsCallable:a}=await e(async()=>{const{getFunctions:e,httpsCallable:t}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Z);return{getFunctions:e,httpsCallable:t}},[]),r=a(t(),"getUserClaims"),i=await r();return i.data,i.data}catch(t){throw V.error("Failed to get user claims:",t),new X("Failed to get user claims","get-claims-failed",t)}}}const ae={ORGANIZATIONS:"organizations",USERS:"users",EMPLOYEES:"employees",WARNINGS:"warnings",WARNING_CATEGORIES:"warningCategories",ESCALATION_RULES:"escalationRules",AUDIT_LOGS:"auditLogs",DOCUMENTS:"documents",TEMPLATES:"templates"};class re{static getServerTimestamp(){return E()}static getClientTimeForDisplay(){return new Date}static formatSADateTime(e){return("string"==typeof e?new Date(e):e).toLocaleString("en-ZA",{timeZone:"Africa/Johannesburg",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}static formatSADate(e){return("string"==typeof e?new Date(e):e).toLocaleDateString("en-ZA",{timeZone:"Africa/Johannesburg",year:"numeric",month:"2-digit",day:"2-digit"})}static getClientISOString(){return V.warn("‚ö†Ô∏è CLIENT ISO STRING - For display/calculation only, NOT for database storage"),(new Date).toISOString()}static daysBetween(e,t){const a="string"==typeof e?new Date(e):e,r="string"==typeof t?new Date(t):t,i=Math.abs(r.getTime()-a.getTime());return Math.ceil(i/864e5)}static isServerTimestamp(e){return e&&"object"==typeof e&&"_methodName"in e}static getWarningExpiryTimestamp(){return E()}static createAuditTimestamp(e,t){return{action:e,userId:t,timestamp:E(),source:"web-client"}}}const ie=Object.freeze(Object.defineProperty({__proto__:null,TimeService:re},Symbol.toStringTag,{value:"Module"}));class ne{static{this.config={maxDocumentsPerShard:1e4,enableCollectionGroups:!0,enableCrossOrgQueries:!1,cacheEnabled:!0,batchSize:500}}static{this.pathCache=new Map}static getShardedPath(e,t){const a=`${e}:${t}`;if(this.config.cacheEnabled&&this.pathCache.has(a))return this.pathCache.get(a);const r=`organizations/${e}/${t}`;return this.config.cacheEnabled&&this.pathCache.set(a,r),r}static getShardedCollection(e,t){const a=this.getShardedPath(e,t);return w(K,a)}static getShardedDocument(e,t,a){const r=this.getShardedPath(e,t);return h(K,r,a)}static async createDocument(e,t,a,r){try{const i=Date.now(),n=this.getShardedCollection(e,t);let o;r?(o=h(n,r),await D(o,{...a,organizationId:e,createdAt:re.getServerTimestamp(),updatedAt:re.getServerTimestamp()})):o=await z(n,{...a,organizationId:e,createdAt:re.getServerTimestamp(),updatedAt:re.getServerTimestamp()});Date.now();return o.id,this.getShardedPath(e,t),o.id}catch(i){throw V.error(`‚ùå [SHARD] Create failed for ${e}/${t}:`,i),i}}static async getDocument(e,t,a){try{const r=Date.now(),i=this.getShardedDocument(e,t,a),n=await y(i);Date.now();return n.exists(),n.exists()?{id:n.id,...n.data()}:null}catch(r){throw V.error(`‚ùå [SHARD] Read failed for ${e}/${t}/${a}:`,r),r}}static async updateDocument(e,t,a,r){try{const i=Date.now(),n=this.getShardedDocument(e,t,a);await A(n,{...r,updatedAt:re.getServerTimestamp()});Date.now()}catch(i){throw V.error(`‚ùå [SHARD] Update failed for ${e}/${t}/${a}:`,i),i}}static async deleteDocument(e,t,a){try{const r=Date.now(),i=this.getShardedDocument(e,t,a);await b(i);Date.now()}catch(r){throw V.error(`‚ùå [SHARD] Delete failed for ${e}/${t}/${a}:`,r),r}}static async queryDocuments(e,t,a=[],r){try{const i=Date.now(),n=this.getShardedCollection(e,t);let o=v(n,...a);r&&(r.orderField&&(o=v(o,x(r.orderField,r.orderDirection||"desc"))),r.lastDocument&&(o=v(o,N(r.lastDocument))),o=v(o,I(r.pageSize)));const s=await f(o),c=s.docs.map(e=>({...e.data(),id:e.id})),l=Date.now()-i,d=s.docs[s.docs.length-1];return c.length,s.docs.length,{documents:c,lastDocument:d,hasMore:!!r&&s.docs.length===r.pageSize,shardInfo:{organizationId:e,path:this.getShardedPath(e,t),queryTime:l}}}catch(i){throw"permission-denied"===i?.code||i?.message?.includes("Missing or insufficient permissions")||V.error(`‚ùå [SHARD] Query failed for ${e}/${t}:`,i),i}}static async queryCollectionGroup(e,t=[],a){if(!this.config.enableCrossOrgQueries)throw new Error("Cross-organization queries are disabled for security");try{const r=Date.now(),i=R(K,e);let n=v(i,...t);a&&(a.orderField&&(n=v(n,x(a.orderField,a.orderDirection||"desc"))),a.lastDocument&&(n=v(n,N(a.lastDocument))),n=v(n,I(a.pageSize)));const o=await f(n),s=o.docs.map(e=>({...e.data(),id:e.id})),c=Date.now()-r,l=o.docs[o.docs.length-1];return V.warn(`‚ö†Ô∏è [SHARD] Cross-org query executed in ${c}ms`,{collection:e,resultCount:s.length,security:"CROSS_ORG_QUERY_USED"}),{documents:s,lastDocument:l,hasMore:!!a&&o.docs.length===a.pageSize,shardInfo:{organizationId:"COLLECTION_GROUP",path:`collectionGroup(${e})`,queryTime:c}}}catch(r){throw V.error(`‚ùå [SHARD] Collection group query failed for ${e}:`,r),r}}static async batchWrite(e){try{const t=Date.now(),a=O(K);for(const i of e){const{organizationId:e,collectionName:t,operation:r,documentId:n,data:o}=i;if("create"===r){const r=n?this.getShardedDocument(e,t,n):h(this.getShardedCollection(e,t));a.set(r,{...o,organizationId:e,createdAt:new Date,updatedAt:re.getServerTimestamp()})}else if("update"===r&&n){const r=this.getShardedDocument(e,t,n);a.update(r,{...o,updatedAt:re.getServerTimestamp()})}else if("delete"===r&&n){const r=this.getShardedDocument(e,t,n);a.delete(r)}}await a.commit();const r=Date.now()-t;V.success(`üì¶ [SHARD] Batch operation completed in ${r}ms`,{operationCount:e.length,organizations:[...new Set(e.map(e=>e.organizationId))]})}catch(t){throw V.error("‚ùå [SHARD] Batch write failed:",t),t}}static async getShardStatistics(e){try{const t=["warnings","employees","categories","meetings","absences"],a=[];let r=0;for(const i of t){const t=(await this.queryDocuments(e,i,[],{pageSize:1e3})).documents.length;r+=t,a.push({name:i,documentCount:t,path:this.getShardedPath(e,i)})}return{organizationId:e,collections:a,totalDocuments:r,shardHealth:r>.8*this.config.maxDocumentsPerShard?"warning":r>this.config.maxDocumentsPerShard?"critical":"healthy"}}catch(t){throw V.error(`‚ùå [SHARD] Statistics failed for ${e}:`,t),t}}static async getSystemShardingMetrics(){return{totalOrganizations:2700,averageDocumentsPerOrg:8500,largestShards:[{organizationId:"large-corp-1",documentCount:95e3},{organizationId:"enterprise-2",documentCount:87e3},{organizationId:"global-org-3",documentCount:76e3}],performanceMetrics:{averageQueryTime:245,slowQueries:12,errorRate:.003}}}static async migrateFlatToSharded(e,t,a=100){V.warn(`üîÑ [MIGRATION] Starting migration: ${e} -> ${t}`);const r={migrated:0,failed:0,skipped:0,errors:[]};try{const n=w(K,e),o=v(n,I(a));let s=null,c=!0;for(;c;){let e=o;s&&(e=v(n,N(s),I(a)));const l=await f(e);if(l.empty){c=!1;continue}const d=[];for(const a of l.docs){const e=a.data();e.organizationId?d.push({organizationId:e.organizationId,collectionName:t,operation:"create",documentId:a.id,data:e}):(r.skipped++,r.errors.push(`Document ${a.id} missing organizationId`))}try{await this.batchWrite(d),r.migrated+=d.length,d.length}catch(i){r.failed+=d.length,r.errors.push(`Batch migration failed: ${i}`),V.error("‚ùå [MIGRATION] Batch failed:",i)}s=l.docs[l.docs.length-1],c=l.docs.length===a}return V.success(`üéâ [MIGRATION] Completed: ${r.migrated} migrated, ${r.failed} failed, ${r.skipped} skipped`),r}catch(i){throw V.error("‚ùå [MIGRATION] Migration failed:",i),i}}static updateConfig(e){this.config={...this.config,...e},this.config}static clearCache(){this.pathCache.clear()}}const oe=Object.freeze(Object.defineProperty({__proto__:null,DatabaseShardingService:ne},Symbol.toStringTag,{value:"Module"}));class se{static{this.CACHE_DURATION=3e5}static{this.cache=new Map}static clearCache(){this.cache.clear()}static async loadEmployees(e,t){try{const a=`employees:${e}:${JSON.stringify(t||{})}`;if(!t&&this.isCacheValid(a)){return{documents:this.cache.get(a).data,hasMore:!1,shardInfo:{organizationId:e,path:ne.getShardedPath(e,"employees"),queryTime:0}}}const r=await ne.queryDocuments(e,"employees",[],t||{pageSize:1e3,orderField:"createdAt",orderDirection:"desc"}),i=r.documents.filter(e=>"metadata"!==e.id&&(!!(e.profile||e.firstName||e.lastName)&&!1!==e.isActive));return r.documents=i,t||this.cache.set(a,{data:r.documents,timestamp:Date.now(),organizationId:e}),V.success(`üë• [SHARD] Loaded ${r.documents.length} employees for ${e}`),r}catch(a){throw"permission-denied"===a?.code||a?.message?.includes("Missing or insufficient permissions")||V.error(`‚ùå [SHARD] Failed to load employees for ${e}:`,a),a}}static async getAllEmployees(e){try{return(await this.loadEmployees(e)).documents}catch(t){throw V.error(`‚ùå [SHARD] Failed to get all employees for ${e}:`,t),t}}static async getEmployeeById(e,t){try{const a=await ne.getDocument(t,"employees",e);return a?(a.profile,a.profile):V.warn(`‚ö†Ô∏è [SHARD] Employee not found: ${e} in ${t}`),a}catch(a){throw V.error(`‚ùå [SHARD] Failed to get employee ${e}:`,a),a}}static async createEmployee(e,t){try{const a=await ne.createDocument(t,"employees",{...e,organizationId:t,isActive:!0,createdAt:new Date,updatedAt:new Date});return this.invalidateCache(`employees:${t}`),V.success(`‚úÖ [SHARD] Created employee: ${e.firstName} ${e.lastName}`),a}catch(a){throw V.error("‚ùå [SHARD] Failed to create employee:",a),a}}static async updateEmployee(e,t,a){try{await ne.updateDocument(t,"employees",e,a),this.invalidateCache(`employees:${t}`),V.success(`‚úÖ [SHARD] Updated employee: ${e}`)}catch(r){throw V.error(`‚ùå [SHARD] Failed to update employee ${e}:`,r),r}}static async saveEmployee(e,t){try{if(e.id){await this.updateEmployee(e.id,t,e);const a=await this.getEmployeeById(e.id,t);if(!a)throw new Error("Failed to retrieve updated employee");return a}{const a=await this.createEmployee(e,t),r=await this.getEmployeeById(a,t);if(!r)throw new Error("Failed to retrieve created employee");return r}}catch(a){throw V.error("‚ùå [SHARD] Failed to save employee:",a),a}}static async loadArchivedEmployees(e,t){try{const a=`archived-employees:${e}:${JSON.stringify(t||{})}`;if(!t&&this.isCacheValid(a)){return{documents:this.cache.get(a).data,hasMore:!1,shardInfo:{organizationId:e,path:ne.getShardedPath(e,"employees"),queryTime:0}}}const r=await ne.queryDocuments(e,"employees",[],t||{pageSize:1e3,orderField:"archivedAt",orderDirection:"desc"}),i=r.documents.filter(e=>!(!e.profile||"metadata"===e.id)&&!1===e.isActive);return r.documents=i,t||this.cache.set(a,{data:r.documents,timestamp:Date.now(),organizationId:e}),V.success(`üóÑÔ∏è [SHARD] Loaded ${r.documents.length} archived employees for ${e}`),r}catch(a){throw V.error(`‚ùå [SHARD] Failed to load archived employees for ${e}:`,a),a}}static async archiveEmployee(e,t){try{await this.updateEmployee(e,t,{isActive:!1,archivedAt:new Date}),this.invalidateCache(`employees:${t}`),this.invalidateCache(`archived-employees:${t}`),V.success(`üóÑÔ∏è [SHARD] Archived employee: ${e}`)}catch(a){throw V.error(`‚ùå [SHARD] Failed to archive employee ${e}:`,a),a}}static async deleteDocument(e,t,a){try{await ne.deleteDocument(e,t,a),this.invalidateCache(`${t}:${e}`),V.warn(`üóëÔ∏è [SHARD] PERMANENTLY DELETED document: ${a} from ${t}`)}catch(r){throw V.error(`‚ùå [SHARD] Failed to delete document ${a}:`,r),r}}static async loadWarnings(e,t,a){try{const r=[];t?.employeeId&&r.push(S("employeeId","==",t.employeeId)),t?.categoryId&&r.push(S("categoryId","==",t.categoryId)),t?.level&&r.push(S("level","==",t.level)),void 0!==t?.isActive&&r.push(S("isActive","==",t.isActive));const i=await ne.queryDocuments(e,"warnings",r,a||{pageSize:500,orderField:"issueDate",orderDirection:"desc"});return V.success(`‚ö†Ô∏è [SHARD] Loaded ${i.documents.length} warnings for ${e}`),i}catch(r){throw"permission-denied"===r?.code||r?.message?.includes("Missing or insufficient permissions")||V.error(`‚ùå [SHARD] Failed to load warnings for ${e}:`,r),r}}static async getActiveWarningsForEmployee(e,t){try{const a=await this.loadWarnings(t,{employeeId:e,isActive:!0},{pageSize:100,orderField:"issueDate",orderDirection:"desc"});return a.documents.length,a.documents}catch(a){throw V.error(`‚ùå [SHARD] Failed to get active warnings for employee ${e}:`,a),a}}static async getAllWarningsForEmployee(e,t,a=!0){try{const r={employeeId:e};a||(r.isActive=!0);const i=await this.loadWarnings(t,r,{pageSize:500,orderField:"issueDate",orderDirection:"desc"});return i.documents.length,i.documents}catch(r){throw V.error(`‚ùå [SHARD] Failed to get all warnings for employee ${e}:`,r),r}}static async createWarning(e,t){try{const a=await ne.createDocument(t,"warnings",{...e,organizationId:t,isActive:!0,status:"issued",createdAt:new Date,updatedAt:new Date});return V.success(`‚úÖ [SHARD] Created warning: ${a} for ${e.employeeId}`),a}catch(a){throw V.error("‚ùå [SHARD] Failed to create warning:",a),a}}static async getWarning(e,t){try{return await ne.getDocument(e,"warnings",t)}catch(a){return V.error(`‚ùå [SHARD] Failed to get warning ${t}:`,a),null}}static async getWarningCategories(e){try{const t=`categories:${e}`;if(this.isCacheValid(t)){return this.cache.get(t).data}const a=await ne.queryDocuments(e,"categories",[S("isActive","==",!0)],{pageSize:100,orderField:"name",orderDirection:"asc"});return this.cache.set(t,{data:a.documents,timestamp:Date.now(),organizationId:e}),V.success(`üìÇ [SHARD] Loaded ${a.documents.length} categories for ${e}`),a.documents}catch(t){throw"permission-denied"===t?.code||t?.message?.includes("Missing or insufficient permissions")||V.error(`‚ùå [SHARD] Failed to load categories for ${e}:`,t),t}}static async createWarningCategory(e,t){try{const a=await ne.createDocument(t,"categories",{...e,organizationId:t,isActive:!0,createdAt:new Date,updatedAt:new Date});return this.invalidateCache(`categories:${t}`),V.success(`‚úÖ [SHARD] Created category: ${e.name}`),a}catch(a){throw V.error("‚ùå [SHARD] Failed to create category:",a),a}}static async createDocument(e,t,a,r){try{const i=await ne.createDocument(e,t,a,r);return this.invalidateCache(`${t}:${e}`),V.success(`‚úÖ [SHARD] Created document in ${t}: ${i}`),i}catch(i){throw V.error(`‚ùå [SHARD] Failed to create document in ${t}:`,i),i}}static async queryDocuments(e,t,a=[],r){try{const i=await ne.queryDocuments(e,t,a,r||{pageSize:1e3,orderField:"createdAt",orderDirection:"desc"});return i.documents.length,i}catch(i){throw V.error(`‚ùå [SHARD] Failed to query documents from ${t}:`,i),i}}static async getOrganizationStats(e){try{const[t,a]=await Promise.all([this.loadEmployees(e),this.loadWarnings(e,{isActive:!0})]),r={},i={};for(const e of a.documents)r[e.level]=(r[e.level]||0)+1,i[e.categoryId]=(i[e.categoryId]||0)+1;const n=Array.from({length:12},(e,t)=>({month:new Date(0,t).toLocaleString("default",{month:"short"}),count:Math.floor(50*Math.random())})),o={totalEmployees:t.documents.length,activeWarnings:a.documents.length,warningsByLevel:r,warningsByCategory:i,monthlyTrends:n};return V.success(`üìä [SHARD] Generated stats for ${e}`),o}catch(t){throw V.error(`‚ùå [SHARD] Failed to generate stats for ${e}:`,t),t}}static async getSystemAnalytics(){return{totalOrganizations:2700,totalEmployees:13500,totalWarnings:8100,topOrganizations:[{name:"Global Enterprise Corp",organizationId:"global-1",employeeCount:250},{name:"Large Manufacturing Ltd",organizationId:"mfg-2",employeeCount:180},{name:"Tech Solutions Inc",organizationId:"tech-3",employeeCount:150}],performanceMetrics:{averageQueryTime:245,cacheHitRate:.85,shardDistribution:{small:2100,medium:500,large:95,enterprise:5}}}}static async bulkCreateEmployees(e,t){try{const r={success:0,failed:0,errors:[]},i=100;for(let n=0;n<e.length;n+=i){const o=e.slice(n,n+i),s=o.map(e=>({organizationId:t,collectionName:"employees",operation:"create",data:{...e,organizationId:t,isActive:!0,createdAt:new Date,updatedAt:new Date}}));try{await ne.batchWrite(s),r.success+=o.length}catch(a){r.failed+=o.length,r.errors.push(`Batch ${n/i+1}: ${a}`)}}return this.invalidateCache(`employees:${t}`),V.success(`üì¶ [SHARD] Bulk created ${r.success} employees, ${r.failed} failed`),r}catch(a){throw V.error("‚ùå [SHARD] Bulk create employees failed:",a),a}}static isCacheValid(e){const t=this.cache.get(e);return void 0!==t&&Date.now()-t.timestamp<this.CACHE_DURATION}static invalidateCache(e){for(const[t]of this.cache)t.includes(e)&&this.cache.delete(t)}static getCacheStats(){let e=0,t=Date.now();for(const[a,r]of this.cache)e+=JSON.stringify(r).length,r.timestamp<t&&(t=r.timestamp);return{totalEntries:this.cache.size,cacheSize:e,hitRate:.85,oldestEntry:t}}static async migrateOrganizationToShards(e){V.warn(`üîÑ [MIGRATION] Starting organization migration: ${e}`);try{const[t,a,r]=await Promise.all([ne.migrateFlatToSharded("employees","employees"),ne.migrateFlatToSharded("warnings","warnings"),ne.migrateFlatToSharded("warningCategories","categories")]),i={employees:{migrated:t.migrated,failed:t.failed},warnings:{migrated:a.migrated,failed:a.failed},categories:{migrated:r.migrated,failed:r.failed}};return V.success(`üéâ [MIGRATION] Organization ${e} migration complete`,i),i}catch(t){throw V.error(`‚ùå [MIGRATION] Organization migration failed for ${e}:`,t),t}}}const ce=Object.freeze(Object.defineProperty({__proto__:null,ShardedDataService:se},Symbol.toStringTag,{value:"Module"}));class le{static{this.COLLECTION="userOrgIndex"}static{this.CACHE_TTL=3e5}static{this.cache=new Map}static async getUserOrganization(e){try{const t=this.cache.get(e);if(t&&Date.now()-t.timestamp<this.CACHE_TTL)return t.entry;const a=await te.getDocument(this.COLLECTION,e);return a?(this.cache.set(e,{entry:a,timestamp:Date.now()}),V.success(`‚úÖ Found user organization mapping: ${e} ‚Üí ${a.organizationId}`),a):null}catch(t){return V.error("‚ùå Error fetching user organization mapping:",t),null}}static async setUserOrganization(e,t,a,r,i="sharded"){try{const n={userId:e,organizationId:t,role:a,email:r,isActive:!0,lastUpdated:new Date,userType:i};await te.setDocument(this.COLLECTION,e,n),this.cache.set(e,{entry:n,timestamp:Date.now()}),V.success(`‚úÖ User organization mapping created: ${e} ‚Üí ${t}`)}catch(n){throw V.error("‚ùå Error creating user organization mapping:",n),n}}static async removeUserOrganization(e){try{await te.deleteDocument(this.COLLECTION,e),this.cache.delete(e),V.success(`‚úÖ User organization mapping removed: ${e}`)}catch(t){throw V.error("‚ùå Error removing user organization mapping:",t),t}}static async setUserActiveStatus(e,t){try{const a=await this.getUserOrganization(e);if(a){const r={...a,isActive:t,lastUpdated:new Date};await te.updateDocument(this.COLLECTION,e,r),this.cache.set(e,{entry:r,timestamp:Date.now()}),V.success(`‚úÖ User active status updated: ${e} ‚Üí ${t}`)}}catch(a){throw V.error("‚ùå Error updating user active status:",a),a}}static async getOrganizationUsers(e){try{const t=await te.queryDocuments(this.COLLECTION,[{field:"organizationId",operator:"==",value:e},{field:"isActive",operator:"==",value:!0}]);return V.success(`‚úÖ Found ${t.length} users for organization: ${e}`),t}catch(t){return V.error("‚ùå Error fetching organization users:",t),[]}}static async getUserWithOrganization(e){try{const t=await this.getUserOrganization(e);if(!t)return null;let a=null;return a="flat"===t.userType?await te.getDocument("users",e):await ne.getDocument(t.organizationId,"users",e),a?{user:a,organizationId:t.organizationId}:(V.warn(`‚ö†Ô∏è Index exists but user data missing for ${e}, cleaning up index...`),await this.removeUserOrganization(e),null)}catch(t){return V.error("‚ùå Error getting user with organization:",t),null}}static clearCache(){this.cache.clear()}static async migrateExistingUsers(){try{const t=await te.getCollection("users");for(const e of t)e.id&&e.email&&e.role&&await this.setUserOrganization(e.id,e.organizationId||"system",e.role,e.email,"flat");const a=await te.getCollection("organizations");for(const r of a)try{const e=await ne.getCollection(r.id,"users");for(const t of e)t.id&&t.email&&t.role&&await this.setUserOrganization(t.id,r.id,t.role,t.email,"sharded");e.length,r.id}catch(e){V.error(`‚ùå Error migrating users from organization ${r.id}:`,e)}V.success("‚úÖ User organization index migration completed")}catch(e){throw V.error("‚ùå Error during migration:",e),e}}static async healthCheck(){const e=[];try{const a=await te.getCollection(this.COLLECTION);for(const i of a)try{if("flat"===i.userType){await te.getDocument("users",i.userId)||e.push(`Orphaned flat user index: ${i.userId}`)}else{await ne.getDocument(i.organizationId,"users",i.userId)||e.push(`Orphaned sharded user index: ${i.userId} in ${i.organizationId}`)}}catch(t){e.push(`Error checking user ${i.userId}: ${t}`)}const r=0===e.length;return r?V.success("‚úÖ User organization index health check passed"):V.warn(`‚ö†Ô∏è User organization index health check found ${e.length} issues`),{healthy:r,issues:e}}catch(t){return V.error("‚ùå Error during health check:",t),{healthy:!1,issues:[`Health check failed: ${t}`]}}}}class de{static{this.validationQueue=new Set}static async validateInBackground(e){const t=e.uid;if(!this.validationQueue.has(t)){this.validationQueue.add(t);try{const a=(await e.getIdTokenResult()).claims,r=a.r||a.role,i=a.v||0;r?V.success(`‚úÖ [CLAIMS] Valid claims found for user ${t} (version ${i})`):(V.warn("‚ö†Ô∏è [CLAIMS] Missing claims detected, will auto-refresh on next login"),V.warn("‚ö†Ô∏è [CLAIMS] User can still proceed - Firestore is source of truth"),this.scheduleRefresh(t))}catch(a){V.error("‚ùå [CLAIMS] Background validation failed:",a)}finally{this.validationQueue.delete(t)}}}static scheduleRefresh(e){try{localStorage.setItem(`claims_refresh_${e}`,Date.now().toString())}catch(t){V.warn("‚ö†Ô∏è [CLAIMS] Failed to schedule refresh:",t)}}static shouldRefresh(e){try{const t=localStorage.getItem(`claims_refresh_${e}`);if(t){const a=parseInt(t,10);if(Date.now()-a<6048e5)return localStorage.removeItem(`claims_refresh_${e}`),!0;localStorage.removeItem(`claims_refresh_${e}`)}}catch(t){V.warn("‚ö†Ô∏è [CLAIMS] Failed to check refresh schedule:",t)}return!1}static async forceRefresh(e){try{e.uid,await e.getIdToken(!0),V.success("‚úÖ [CLAIMS] Token refreshed successfully")}catch(t){throw V.error("‚ùå [CLAIMS] Force refresh failed:",t),t}}}const ue="users",ge="organizations",me=e=>{if("object"==typeof e&&e?.id)return e;if("string"==typeof e){const t={"super-user":"Global system administrator with full access",reseller:"Partner with client organization management access","executive-management":"Organization owner with business oversight","hr-manager":"Human resources manager with employee management access","hod-manager":"Department head with team management capabilities","department-manager":"Department manager with team management capabilities"},a={"super-user":1,reseller:2,"executive-management":3,"hr-manager":4,"hod-manager":5,"department-manager":5};return{id:e,name:{"super-user":"Super User",reseller:"Reseller","executive-management":"Executive Management","hr-manager":"HR Manager","hod-manager":"Department Manager","department-manager":"Department Manager"}[e]||e.charAt(0).toUpperCase()+e.slice(1),description:t[e]||`${e} role`,level:a[e]||5}}return V.warn("‚ö†Ô∏è Invalid role format detected:",e),{id:"unknown",name:"Unknown Role",description:"Role format not recognized",level:99}},pe=(e,t)=>{switch(t.type){case"SET_LOADING":return{...e,loading:t.payload};case"SET_USER":return{...e,user:t.payload,loading:!1,error:null};case"SET_ORGANIZATION":return{...e,organization:t.payload};case"SET_CATEGORIES":return{...e,categories:t.payload};case"SET_ERROR":return{...e,error:t.payload,loading:!1};case"LOGOUT":return{user:null,organization:null,categories:null,loading:!1,error:null};default:return e}},he={user:null,organization:null,categories:null,loading:!0,error:null},ye=a.createContext(void 0),we=({children:t})=>{const[r,i]=a.useReducer(pe,he);a.useEffect(()=>p(G,async e=>{try{if(e){if(e.email,J.isPendingUser(e.uid))return i({type:"SET_LOADING",payload:!0}),void setTimeout(async()=>{const t=await le.getUserWithOrganization(e.uid);if(t){const e=me(t.user.role);if(i({type:"SET_USER",payload:{...t.user,role:e}}),t.organizationId&&"system"!==t.organizationId){const e=await te.getDocument(ge,t.organizationId);e&&i({type:"SET_ORGANIZATION",payload:e})}}else V.error("‚ùå User creation completed but user not found in index"),i({type:"SET_ERROR",payload:"User profile not found after creation"});i({type:"SET_LOADING",payload:!1})},2e3);const[r,n]=await Promise.allSettled([le.getUserWithOrganization(e.uid),(async()=>{try{const t=(await e.getIdTokenResult()).claims;if(t.orgId||t.organizationId){const e=t.orgId||t.organizationId;return await te.getDocument(ge,e)}return null}catch{return null}})()]);if(de.validateInBackground(e).catch(e=>{V.warn("‚ö†Ô∏è [AUTH] Background claims validation encountered an error (non-blocking):",e)}),"fulfilled"===r.status&&r.value){const e=r.value;if(!1===e.user.isActive)return V.warn("‚ö†Ô∏è [AUTH] User account is inactive"),await G.signOut(),void i({type:"SET_ERROR",payload:"Your account has been deactivated. Please contact support."});const a=me(e.user.role);if(i({type:"SET_USER",payload:{...e.user,role:a}}),e.organizationId&&"system"!==e.organizationId){let a=null,r=null;if("fulfilled"===n.status&&n.value){a=n.value;try{r=await se.getWarningCategories(e.organizationId)}catch(t){V.warn("‚ö†Ô∏è Failed to fetch categories during auth (non-critical):",t),r=[]}}else{const[t,i]=await Promise.allSettled([te.getDocument(ge,e.organizationId),se.getWarningCategories(e.organizationId)]);a="fulfilled"===t.status?t.value:null,r="fulfilled"===i.status?i.value:[]}a&&i({type:"SET_ORGANIZATION",payload:a}),null!==r&&i({type:"SET_CATEGORIES",payload:r})}V.success(`‚úÖ User authenticated via index: ${e.user.email} ‚Üí ${e.organizationId}`)}else{let r=await te.getDocument(ue,e.uid);if(r){V.success("‚úÖ Found user in flat structure (super user/reseller)");try{await le.setUserOrganization(e.uid,r.organizationId||"system",r.role,r.email,"flat"),V.success(`‚úÖ Created index entry for flat user: ${e.uid}`)}catch(a){V.error("‚ùå Failed to create index entry for flat user:",a)}}else{const n=(await te.getCollection(ge)).map(async a=>{try{const t=await ne.getDocument(a.id,"users",e.uid);return t?{user:t,orgId:a.id}:null}catch(t){return null}}),o=(await Promise.all(n)).find(e=>null!==e);if(o){r=o.user,V.success(`‚úÖ Found user in sharded organization: ${o.orgId}`);try{await le.setUserOrganization(e.uid,o.orgId,r.role,r.email,"sharded"),V.success(`‚úÖ Created index entry for user: ${e.uid}`)}catch(a){V.error("‚ùå Failed to create index entry:",a)}const[t,n]=await Promise.allSettled([te.getDocument(ge,o.orgId),se.getWarningCategories(o.orgId)]);"fulfilled"===t.status&&t.value&&i({type:"SET_ORGANIZATION",payload:t.value}),"fulfilled"===n.status&&n.value&&(i({type:"SET_CATEGORIES",payload:n.value}),n.value.length)}}if(r){const e=me(r.role);i({type:"SET_USER",payload:{...r,role:e}})}else V.error("‚ùå User not found in any organization"),i({type:"SET_ERROR",payload:"User profile not found"})}}else i({type:"LOGOUT"})}catch(t){V.error("‚ùå Error in authentication flow:",t),i({type:"SET_ERROR",payload:"Authentication error occurred. Please try again."})}finally{i({type:"SET_LOADING",payload:!1})}}),[]);const n={user:r.user,organization:r.organization,categories:r.categories,loading:r.loading,error:r.error,login:async(e,t)=>{try{if(!e||!t)throw new Error("Email and password are required");if(!e.includes("@"))throw new Error("Please enter a valid email address");i({type:"SET_LOADING",payload:!0}),i({type:"SET_ERROR",payload:null});if(!(await te.signIn(e,t)))throw new Error("Authentication failed");V.success("‚úÖ Firebase authentication successful")}catch(a){let e="Login failed";throw a instanceof Error&&(e=a.message.includes("user-not-found")?"No account found with this email address":a.message.includes("wrong-password")?"Incorrect password":a.message.includes("invalid-email")?"Invalid email address format":a.message.includes("too-many-requests")?"Too many failed attempts. Please try again later":a.message.includes("user-disabled")?"This account has been disabled. Please contact support":a.message),V.error("‚ùå Login failed:",e),i({type:"SET_ERROR",payload:e}),new Error(e)}},logout:async()=>{try{await te.signOut(),V.success(10222)}catch(e){V.error("‚ö†Ô∏è Logout error:",e),i({type:"LOGOUT"})}},switchOrganization:async e=>{if(!r.user)throw new Error("No authenticated user");if("super-user"!==r.user.role.id)throw new Error("Only super users can switch organizations");try{if(i({type:"SET_LOADING",payload:!0}),i({type:"SET_ERROR",payload:null}),"all"===e||""===e)i({type:"SET_ORGANIZATION",payload:null});else{const t=await te.getDocument(ge,e);if(!t)throw new Error(`Organization '${e}' not found`);V.success(11662),i({type:"SET_ORGANIZATION",payload:t})}}catch(t){const e=t instanceof Error?t.message:"Failed to switch organization";throw V.error("‚ùå Organization switch failed:",e),i({type:"SET_ERROR",payload:e}),t}finally{i({type:"SET_LOADING",payload:!1})}},resetPassword:async t=>{try{if(!t||!t.trim())throw new Error("Email address is required");if(!t.includes("@"))throw new Error("Please enter a valid email address");i({type:"SET_ERROR",payload:null});const{sendPasswordResetEmail:a}=await e(async()=>{const{sendPasswordResetEmail:e}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.X);return{sendPasswordResetEmail:e}},[]);await a(G,t.trim()),V.success("‚úÖ Password reset email sent successfully")}catch(a){let e="Failed to send password reset email";if(a instanceof Error&&(a.message.includes("user-not-found")||(e=a.message.includes("invalid-email")?"Invalid email address format":a.message.includes("too-many-requests")?"Too many reset attempts. Please try again later":a.message)),a instanceof Error&&a.message.includes("user-not-found"))return;throw V.error("‚ùå Password reset failed:",e),i({type:"SET_ERROR",payload:e}),new Error(e)}}};return H.jsx(ye.Provider,{value:n,children:t})},ve=()=>{const e=a.useContext(ye);if(!e)throw new Error("useAuth must be used within an AuthProvider");return e};class fe{static async getWarningCategories(e){try{const t=w(K,"organizations",e,"categories"),a=v(t,S("isActive","==",!0),x("name"));return(await f(a)).docs.map(e=>({id:e.id,...e.data()}))}catch(t){return V.error("[DataServiceV2] Error getting categories:",t),[]}}static async getWarningCategory(e,t){try{const a=h(K,"organizations",e,"categories",t),r=await y(a);return r.exists()?{id:r.id,...r.data()}:null}catch(a){return V.error("[DataServiceV2] Error getting category:",a),null}}static async updateWarningCategory(e,t,a){try{const r=h(K,"organizations",e,"categories",t);await A(r,{...a,updatedAt:E()})}catch(r){throw V.error("[DataServiceV2] Error updating category:",r),r}}static async getEmployeesByOrganization(e){try{const t=w(K,"organizations",e,"employees"),a=v(t,x("profile.lastName"),x("profile.firstName"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(t){return V.error("[DataServiceV2] Error getting employees:",t),[]}}static async getEmployee(e,t){try{const a=h(K,"organizations",e,"employees",t),r=await y(a);return r.exists()?{id:r.id,...r.data(),createdAt:this.convertDate(r.data().createdAt),updatedAt:this.convertDate(r.data().updatedAt)}:null}catch(a){return V.error("[DataServiceV2] Error getting employee:",a),null}}static async saveEmployee(e,t){try{const a=t.id?h(K,"organizations",e,"employees",t.id):h(w(K,"organizations",e,"employees")),r={...t,organizationId:e,updatedAt:E(),...t.id?{}:{createdAt:E()}};return await D(a,r),a.id}catch(a){throw V.error("[DataServiceV2] Error saving employee:",a),a}}static async employeeNumberExists(e,t){try{const a=w(K,"organizations",e,"employees"),r=v(a,S("profile.employeeNumber","==",t));return!(await f(r)).empty}catch(a){return V.error("[DataServiceV2] Error checking employee number:",a),!1}}static async getWarningsByOrganization(e,t){try{const a=w(K,"organizations",e,"warnings");let r=v(a,x("issueDate","desc"));t&&(r=v(a,x("issueDate","desc"),I(t)));return(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(a){return V.error("[DataServiceV2] Error getting warnings:",a),[]}}static async getWarningsForEmployee(e,t){try{const a=w(K,"organizations",e,"warnings"),r=v(a,S("employeeId","==",t),x("issueDate","desc"));return(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(a){return V.error("[DataServiceV2] Error getting employee warnings:",a),[]}}static async saveWarning(e,t){try{const a=t.id?h(K,"organizations",e,"warnings",t.id):h(w(K,"organizations",e,"warnings")),r={...t,organizationId:e,updatedAt:E(),...t.id?{}:{createdAt:E()}};return await D(a,r),a.id}catch(a){throw V.error("[DataServiceV2] Error saving warning:",a),a}}static async getUsersByOrganization(e){try{const t=w(K,"organizations",e,"users"),a=v(t,S("isActive","==",!0),x("lastName"),x("firstName"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),lastLogin:this.convertOptionalDate(e.data().lastLogin)}))}catch(t){return V.error("[DataServiceV2] Error getting users:",t),[]}}static async getUser(e,t){try{const a=h(K,"organizations",e,"users",t),r=await y(a);return r.exists()?{id:r.id,...r.data(),createdAt:this.convertDate(r.data().createdAt),lastLogin:this.convertOptionalDate(r.data().lastLogin)}:null}catch(a){return V.error("[DataServiceV2] Error getting user:",a),null}}static async getDocumentTemplates(e){try{const t=w(K,"organizations",e,"templates"),a=v(t,S("isActive","==",!0),x("name"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(t){return V.error("[DataServiceV2] Error getting templates:",t),[]}}static async getEscalationRules(e){try{const t=w(K,"organizations",e,"escalationRules"),a=v(t,S("isActive","==",!0),x("category"));return(await f(a)).docs.map(e=>({id:e.id,...e.data()}))}catch(t){return V.error("[DataServiceV2] Error getting escalation rules:",t),[]}}static async getOrganization(e){try{const t=h(K,"organizations",e),a=await y(t);return a.exists()?{id:a.id,...a.data(),createdAt:this.convertDate(a.data().createdAt),updatedAt:this.convertDate(a.data().updatedAt)}:null}catch(t){return V.error("[DataServiceV2] Error getting organization:",t),null}}static convertDate(e){return e?e instanceof _||e.toDate?e.toDate():new Date(e):new Date}static convertOptionalDate(e){return e?this.convertDate(e):null}}class De{static{this.cache=new Map}static{this.accessOrder=new Map}static{this.accessCounter=0}static{this.config={defaultTTL:3e5,maxSize:1e3}}static{this.TTL_CONFIG={employees:12e4,warnings:6e4,followUps:3e4,categories:6e5,organization:18e4,settings:18e4,userOrgIndex:18e5,sectors:36e5,roles:36e5}}static get(e){const t=this.cache.get(e);return t?Date.now()>t.expiryTime?(this.delete(e),null):(this.accessOrder.set(e,++this.accessCounter),t.data):null}static set(e,t,a){const r=a||this.getTTLForKey(e),i=Date.now()+r;this.cache.size>=this.config.maxSize&&this.evictLRU(),this.cache.set(e,{data:t,timestamp:Date.now(),expiryTime:i}),this.accessOrder.set(e,++this.accessCounter)}static delete(e){this.cache.delete(e),this.accessOrder.delete(e)}static clearByPrefix(e){let t=0;for(const a of this.cache.keys())a.startsWith(e)&&(this.cache.delete(a),this.accessOrder.delete(a),t++);V.success(`üßπ [CACHE] Cleared ${t} entries with prefix: ${e}`)}static clear(){const e=this.cache.size;this.cache.clear(),this.accessOrder.clear(),this.accessCounter=0,V.success(`üßπ [CACHE] Cleared all ${e} entries`)}static getStats(){Array.from(this.cache.entries());const e=Array.from(this.accessOrder.entries()),t=e.reduce((e,[t,a])=>a<e.access?{key:t,access:a}:e,{key:"",access:1/0}),a=e.reduce((e,[t,a])=>a>e.access?{key:t,access:a}:e,{key:"",access:-1});return{size:this.cache.size,maxSize:this.config.maxSize,hitRate:0,oldestEntry:t.key||null,newestEntry:a.key||null}}static async getOrFetch(e,t,a){const r=this.get(e);if(null!==r)return r;const i=await t();return this.set(e,i,a),i}static getTTLForKey(e){for(const[t,a]of Object.entries(this.TTL_CONFIG))if(e.includes(t))return a;return this.config.defaultTTL}static has(e){const t=this.cache.get(e);return!!t&&(!(Date.now()>t.expiryTime)||(this.delete(e),!1))}static async preWarmCache(e,t){const a=[this.generateOrgKey(t,"employees:all"),this.generateOrgKey(t,"categories"),this.generateOrgKey(t,"organization")].filter(e=>!this.has(e));0!==a.length&&a.length}static evictLRU(){if(0===this.accessOrder.size)return;let e="",t=1/0;for(const[a,r]of this.accessOrder.entries())r<t&&(t=r,e=a);e&&this.delete(e)}static startCleanupTimer(){setInterval(()=>{this.cleanupExpired()},6e4)}static cleanupExpired(){const e=Date.now();for(const[t,a]of this.cache.entries())e>a.expiryTime&&this.delete(t)}static generateOrgKey(e,t,...a){return`org:${e}:${t}${a.length>0?`:${a.join(":")}`:""}`}static generateUserKey(e,t,...a){return`user:${e}:${t}${a.length>0?`:${a.join(":")}`:""}`}}De.startCleanupTimer();const Ee=a.createContext(null),Ae=()=>{const e=a.useContext(Ee);if(!e)throw new Error("useOrganization must be used within an OrganizationProvider");return e},be=({children:e,organizationId:t,prefetchedOrg:r,prefetchedCategories:i})=>{const[n,o]=a.useState(null),[s,c]=a.useState(null),[l,d]=a.useState(null),[u,g]=a.useState(!0),[m,p]=a.useState(null),h=a.useRef(!1),y=a.useRef(null),w=a.useRef(!1),v=`org-loading-${t}`,f=e=>{"undefined"!=typeof window&&(e?window[v]=!0:delete window[v])},D=async()=>{if(r&&void 0!==i)return o(r),c(i),d(null),g(!1),void(y.current=t);if(!(h.current||"undefined"!=typeof window&&window[v]))if(y.current===t&&n&&null!==s)g(!1);else{if(y.current===t&&s&&s.length>0)return s.length,void g(!1);h.current=!0,f(!0);try{g(!0),p(null);const[e,a]=await Promise.all([De.getOrFetch(De.generateOrgKey(t,"organization"),()=>fe.getOrganization(t)),De.getOrFetch(De.generateOrgKey(t,"categories"),()=>se.getWarningCategories(t))]);e?(o(e),e.name):(V.error(`[OrganizationProvider] üö® Failed to load organization: ${t}`),p("Failed to load organization")),a&&Array.isArray(a)?(a.length,a.map(e=>e.name),c(a)):(V.warn(`[OrganizationProvider] ‚ö†Ô∏è No categories found, setting empty array for organization: ${t}`),c([])),d(null),y.current=t,g(!1)}catch(e){V.error("[OrganizationProvider] üö® Failed to load organization data:",e),p(e instanceof Error?e.message:"Failed to load organization data"),g(!1)}finally{h.current=!1,f(!1)}}};a.useEffect(()=>(w.current||(w.current=!0,t?(y.current!==t&&(h.current=!1,y.current=null,y.current&&De.clearByPrefix(`org:${y.current}:`)),D()):V.warn("[OrganizationProvider] No organizationId provided, skipping data load")),()=>{w.current=!1}),[t]);const E={organization:n,organizationId:t,categories:s,sectorInfo:l,loading:u,error:m,refreshOrganization:async()=>{t&&De.clearByPrefix(`org:${t}:`),h.current=!1,y.current=null,await D()},initializeSector:async(e,t)=>{try{g(!0),V.warn("SectorService not imported - sector initialization disabled"),await D()}catch(a){throw V.error("Failed to initialize sector:",a),a}}};return a.useEffect(()=>{!u&&s&&s.length>0&&s.length},[u,s,n]),H.jsx(Ee.Provider,{value:E,children:e})},Se=e=>{const[t,r]=a.useState(()=>"undefined"!=typeof window&&window.innerWidth>e),i=a.useCallback(()=>{r(window.innerWidth>e)},[e]);return a.useEffect(()=>{if("undefined"!=typeof window)return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[i]),t},xe=[{id:"attendance_punctuality",name:"Attendance & Punctuality",description:"Late coming, unauthorized absence, early departure without permission",severity:"minor",icon:"‚è∞",lraSection:"Section 188(1)(a) - Incapacity or poor work performance",schedule8Reference:"Schedule 8, Item 10 - Incapacity/poor performance procedures",escalationPath:["counselling","verbal","first_written","second_written","final_written"],escalationRationale:"Attendance issues are typically correctable behavior problems that benefit from full progressive discipline, giving employees maximum opportunity to improve while building strong legal documentation.",commonExamples:["Arriving late for work without valid reason (3+ times per month)","Leaving work early without supervisor permission","Unauthorized absence during working hours","Excessive sick leave without proper medical certificates","Not notifying supervisor of absence per company policy","Consistently returning late from breaks","Pattern of Monday/Friday absences without valid reasons"],proceduralRequirements:["Maintain accurate attendance records for minimum 6 months","Investigate reasons for poor attendance before disciplinary action","Consider personal circumstances (Schedule 8 factors)","Provide counselling and support where appropriate","Follow progressive discipline unless pattern shows willful misconduct","Document all interventions and employee responses","Allow employee opportunity to provide medical evidence"],evidenceRequired:["Daily attendance register or electronic time records","Previous warnings and counselling records","Medical certificates (if absence-related)","Communication records about absences","Witness statements from supervisors","Company attendance policy documentation","Impact assessment on operations"],ccmaFactors:["Length of service and previous disciplinary record","Personal circumstances affecting attendance","Whether adequate counselling and support was provided","Consistency of employer response to similar cases","Impact on operations and other employees","Economic circumstances and job market conditions","Whether alternative arrangements were considered"],defaultValidityPeriod:6},{id:"performance_issues",name:"Performance Issues",description:"Poor work quality, failure to meet targets, lack of required skills",severity:"minor",icon:"üìà",lraSection:"Section 188(1)(a) - Incapacity or poor work performance",schedule8Reference:"Schedule 8, Item 10 - Poor performance procedures",escalationPath:["counselling","verbal","first_written","second_written","final_written"],escalationRationale:"Performance issues often stem from lack of training, unclear expectations, or personal challenges. Full progressive discipline allows time for coaching, training, and performance improvement plans.",commonExamples:["Consistently missing production targets despite training","Work quality below acceptable company standards","Failure to follow established procedures","Inability to learn new skills required for position","Poor customer service resulting in complaints","Errors in work output affecting quality or safety","Lack of productivity compared to similar employees"],proceduralRequirements:["Provide clear performance standards and expectations","Offer training and development opportunities","Implement performance improvement plans with measurable goals","Regular monitoring and feedback sessions","Consider whether incapacity is due to ill-health or lack of skill","Explore alternative positions if performance cannot improve","Document all training provided and performance measurements"],evidenceRequired:["Performance metrics and measurement records","Training records and certificates","Performance improvement plan documentation","Regular performance review records","Customer complaints or feedback (if applicable)","Comparison with similar employees' performance","Evidence of support and resources provided"],ccmaFactors:["Whether clear performance standards were communicated","Adequacy of training and support provided","Personal circumstances affecting performance","Length of service and previous performance record","Whether alternative positions were considered","Consistency with treatment of other employees","Economic impact of dismissal on employee"],defaultValidityPeriod:6},{id:"safety_violations",name:"Safety Violations",description:"Failure to follow safety procedures, endangering self or others",severity:"serious",icon:"üö®",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["verbal","first_written","final_written"],escalationRationale:"Safety violations can result in injury, death, or legal liability. While counselling might be appropriate for first-time minor oversights, repeated or serious safety violations require formal progressive discipline.",commonExamples:["Failure to wear required Personal Protective Equipment (PPE)","Operating machinery without proper authorization","Ignoring safety procedures and protocols","Creating unsafe working conditions for others","Failure to report safety hazards or incidents","Horseplay or reckless behavior in workplace","Smoking in prohibited areas or fire hazard zones"],proceduralRequirements:["Immediate investigation of safety incidents","Ensure employee understands safety requirements","Provide additional safety training if needed","Consider whether violation was willful or due to lack of knowledge","Implement corrective measures to prevent recurrence","May require temporary removal from dangerous areas","Report serious incidents to relevant authorities"],evidenceRequired:["Incident reports and investigation findings","Safety training records and certificates","Photographs of safety violations or hazards","Witness statements from supervisors or colleagues","Safety inspection reports","Company safety policies and procedures","Medical reports if injury occurred"],ccmaFactors:["Seriousness of safety risk created","Whether violation was willful or negligent","Previous safety training provided","Employee's safety record and length of service","Potential consequences of the safety violation","Consistency of safety enforcement","Industry standards and legal requirements"],defaultValidityPeriod:12,requiresImmediateAction:!0},{id:"insubordination_disrespect",name:"Insubordination & Disrespect",description:"Refusal to follow instructions, disrespectful behavior, undermining authority",severity:"serious",icon:"üö´",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["counselling","verbal","first_written","final_written"],escalationRationale:"Insubordination varies from minor attitude issues (requiring counselling) to serious defiance. Progressive discipline allows distinction between momentary lapses and persistent defiant behavior.",commonExamples:["Refusing to follow reasonable and lawful instructions","Disrespectful language or behavior toward supervisors","Undermining management authority in front of colleagues","Aggressive or threatening behavior toward management","Consistently challenging management decisions inappropriately","Showing contempt for company policies or procedures","Public criticism of management or company"],proceduralRequirements:["Distinguish between reasonable management instruction and unreasonable demands","Consider employee's right to raise legitimate grievances","Assess whether behavior was influenced by workplace stress","Provide opportunity for employee to explain their perspective","Consider mediation or conflict resolution where appropriate","Document specific instances with dates and witnesses","Ensure consistency with treatment of similar cases"],evidenceRequired:["Written statements from witnesses present","Documentation of specific incidents with dates and times","Records of instructions given and employee response","Previous disciplinary records for pattern evidence","Email or written communication showing insubordination","Performance reviews or feedback sessions","Evidence of impact on team morale or productivity"],ccmaFactors:["Severity of the insubordinate behavior","Whether employee had legitimate grievances","Length of service and previous disciplinary record","Impact on workplace authority and discipline","Whether behavior was out of character","Workplace stress factors or personal circumstances","Potential for rehabilitation and improved behavior"],defaultValidityPeriod:6},{id:"policy_violations",name:"Policy Violations",description:"Breach of company policies, procedures, or workplace rules",severity:"minor",icon:"üìã",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["counselling","verbal","first_written","second_written","final_written"],escalationRationale:"Policy violations vary greatly in seriousness. Progressive discipline allows proportionate responses based on policy importance and violation severity.",commonExamples:["Violation of dress code or appearance standards","Inappropriate use of company property or equipment","Breach of confidentiality or privacy policies","Unauthorized use of company internet or email","Violation of social media and communication policies","Failure to follow administrative procedures","Breach of conflict of interest policies"],proceduralRequirements:["Ensure policy was clearly communicated to employee","Verify employee had access to and understood policy","Consider seriousness of policy violated","Investigate whether violation was intentional","Provide policy training if knowledge gaps identified","Consider impact of violation on business operations","Ensure consistent application across all employees"],evidenceRequired:["Copy of relevant company policy document","Evidence of policy communication (training records, handbook)","Documentation of the specific violation","Computer logs, emails, or digital evidence if applicable","Witness statements or supervisor observations","Previous policy violations or training records","Impact assessment on business or colleagues"],ccmaFactors:["Clarity and accessibility of the policy violated","Seriousness of the policy and business impact","Employee's knowledge and understanding of policy","Intent behind the violation","Consistency of policy enforcement","Length of service and previous violations","Whether remedial action is possible"],defaultValidityPeriod:6},{id:"dishonesty_theft",name:"Dishonesty & Theft",description:"Stealing, fraud, falsifying records, dishonest behavior",severity:"gross_misconduct",icon:"üí∞",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["first_written","final_written"],escalationRationale:"Dishonesty and theft break fundamental trust required for employment. Minor dishonesty may warrant progressive discipline, but serious theft or fraud often justifies immediate dismissal after investigation.",commonExamples:["Stealing company property, money, or resources","Fraudulent claiming of overtime or expenses","Falsifying time records, reports, or documentation","Misappropriation of company funds or assets","Lying about qualifications, experience, or credentials","Concealing conflicts of interest or kickbacks","Falsifying safety records or inspection reports"],proceduralRequirements:["Conduct thorough investigation before taking action","Preserve evidence and maintain chain of custody","Consider suspension pending investigation if necessary","Distinguish between minor dishonesty and serious fraud","Involve security or law enforcement if appropriate","Ensure fair hearing and right to respond","Consider whether criminal charges should be laid"],evidenceRequired:["Financial records, receipts, or transaction evidence","Security camera footage or access logs","Witness statements from colleagues or customers","Forensic accounting or audit reports","Documentation of missing inventory or assets","Computer records or digital evidence","Statements from employee during investigation"],ccmaFactors:["Value and nature of property stolen or involved","Level of trust and responsibility in employee's position","Impact on employer's business or reputation","Length of service and previous disciplinary record","Whether employee admitted wrongdoing and showed remorse","Consistency with treatment of similar cases","Potential for rehabilitation vs. need to deter others"],defaultValidityPeriod:12,requiresImmediateAction:!0,allowsWarningSkipping:!0},{id:"substance_abuse",name:"Substance Abuse",description:"Use of alcohol or drugs affecting work performance or safety",severity:"serious",icon:"üç∫",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["counselling","verbal","first_written","final_written"],escalationRationale:"Substance abuse is both a health issue and workplace safety concern. Counselling and support are prioritized initially, but safety concerns require firm boundaries.",commonExamples:["Reporting to work under influence of alcohol or drugs","Possession or use of illegal substances at work","Performance deterioration due to substance abuse","Erratic behavior suggesting intoxication","Positive results on random drug/alcohol testing","Alcohol odor or visible signs of intoxication","Refusing to submit to required substance testing"],proceduralRequirements:["Follow company substance abuse policy procedures","Conduct testing according to established protocols","Distinguish between addiction (health issue) and misconduct","Offer employee assistance programs where available","Consider rehabilitation and treatment options","Ensure safety of employee and colleagues","Document all incidents and interventions"],evidenceRequired:["Drug/alcohol test results and chain of custody","Witness observations of behavior and condition","Supervisor reports of performance decline","Medical evidence or treatment records (if disclosed)","Company substance abuse policies","Previous incidents or test results","Evidence of impact on work performance or safety"],ccmaFactors:["Whether substance abuse affects work performance","Safety implications for employee and colleagues","Employee's willingness to seek treatment","Length of service and previous record","Availability of rehabilitation programs","Consistency of policy application","Balance between health support and workplace safety"],defaultValidityPeriod:6,requiresImmediateAction:!0},{id:"harassment_discrimination",name:"Harassment & Discrimination",description:"Sexual harassment, racial discrimination, bullying, or creating hostile work environment",severity:"gross_misconduct",icon:"‚öñÔ∏è",lraSection:"Section 188(1)(b) - Misconduct",schedule8Reference:"Schedule 8, Item 1 - Misconduct procedures",escalationPath:["final_written"],escalationRationale:"Harassment and discrimination create legal liability and hostile work environments. While investigation is required, proven cases often warrant immediate serious action.",commonExamples:["Sexual harassment or unwanted sexual advances","Racial, gender, or religious discrimination","Bullying, intimidation, or creating hostile environment","Inappropriate comments about appearance or personal life","Displaying offensive material or making discriminatory jokes","Retaliation against employees who report discrimination","Creating work environment that excludes certain groups"],proceduralRequirements:["Immediate investigation by trained investigators","Ensure complainant safety and prevent retaliation","Maintain confidentiality while conducting investigation","Follow company harassment and discrimination policies","Consider interim measures to separate parties","Provide support to affected employees","Report to relevant authorities if required by law"],evidenceRequired:["Written complaint or incident report","Witness statements from colleagues","Documentation of previous similar incidents","Email, text messages, or other communications","Records of previous complaints or warnings","Medical or psychological reports (if applicable)","Evidence of impact on work environment"],ccmaFactors:["Seriousness and persistence of the harassment","Impact on victim and workplace environment","Position of power or authority of perpetrator","Previous incidents or complaints","Whether behavior was part of pattern","Legal and reputational risk to organization","Need to protect other employees and deter similar conduct"],defaultValidityPeriod:12,requiresImmediateAction:!0,allowsWarningSkipping:!0}];function Ie(e){return xe.find(t=>t.id===e)}function Ce(e){const t=Ie(e);return t?.escalationPath||["counselling","verbal","first_written","final_written"]}function ze(e){return{counselling:"Counselling Session",verbal:"Verbal Warning",first_written:"Written Warning",second_written:"Second Written Warning",final_written:"Final Written Warning"}[e]||e}const Ne="organizations",Re="employees",Oe="warnings",_e="auditLogs";class Te{static{this.categoryCache=new Map}static{this.CACHE_DURATION=3e5}static convertDate(e){if(!e)return new Date;if(e instanceof Date)return e;if(e&&"object"==typeof e&&"function"==typeof e.toDate)return e.toDate();const t=new Date(e);return isNaN(t.getTime())?new Date:t}static convertOptionalDate(e){if(e)return this.convertDate(e)}static async getWarningCategories(e){const t=this.categoryCache.get(e);if(t&&Date.now()-t.timestamp<this.CACHE_DURATION)return t.data;try{const t=xe;t.length;const a=w(K,"organizations",e,"categories"),r=v(a,S("isActive","==",!0),x("name")),i=(await f(r)).docs.map(e=>({id:e.id,...e.data(),createdAt:e.data().createdAt?.toDate()||new Date,updatedAt:e.data().updatedAt?.toDate()||new Date}));i.length;const n=[];for(const s of t){const t=i.find(e=>e.universalCategoryId===s.id&&!e.isCustomCategory);if(t&&t.isDisabled){s.name;continue}const a={id:t?.id||s.id,organizationId:e,name:t?.customName||s.name,description:t?.customDescription||s.description,severity:this.mapSeverityToLegacy(t?.customSeverity||s.severity),escalationPath:t?.customEscalationPath||s.escalationPath,legalRequirements:s.proceduralRequirements,examples:t?.customExamples||s.commonExamples,defaultValidityPeriod:s.defaultValidityPeriod,isActive:!0,createdAt:t?.createdAt||new Date,updatedAt:t?.updatedAt||new Date};n.push(a)}const o=i.filter(e=>e.isCustomCategory);for(const s of o){const t={id:s.id,organizationId:e,name:s.customName||"Custom Category",description:s.customDescription||"Organization-specific category",severity:s.customSeverity||"medium",escalationPath:s.customEscalationPath||["counselling","verbal","first_written","final_written"],legalRequirements:["Follow standard progressive discipline procedures"],examples:s.customExamples||[],defaultValidityPeriod:6,isActive:!0,createdAt:s.createdAt,updatedAt:s.updatedAt};n.push(t)}return this.categoryCache.set(e,{data:n,timestamp:Date.now()}),n.length,n.map(e=>`${e.name} (${e.severity})`),n}catch(a){return V.error("[DataService] ‚ùå Error in smart category merge:",a),t?t.data:this.convertUniversalToWarningCategories(e)}}static async getWarningCategory(e,t){try{const a=(await this.getWarningCategories(t)).find(t=>t.id===e);if(a)return a;const r=h(K,"organizations",t,"categories",e),i=await y(r);if(i.exists())return{id:i.id,...i.data(),createdAt:i.data().createdAt?.toDate()||new Date,updatedAt:i.data().updatedAt?.toDate()||new Date};const n=xe.find(t=>t.id===e);return n?this.convertUniversalToWarningCategory(n,t):null}catch(a){return V.error("[DataService] Error getting category:",a),null}}static async customizeCategory(e,t,a){try{const r=t,i=h(K,"organizations",e,"categories",r),n={id:r,organizationId:e,universalCategoryId:t,...a,isCustomCategory:!1,isDisabled:!1,createdAt:new Date,updatedAt:new Date};await D(i,n),this.categoryCache.delete(e)}catch(r){throw V.error("[DataService] Error customizing category:",r),r}}static async createCustomCategory(e,t){try{const a=`custom-${Date.now()}`,r=h(K,"organizations",e,"categories",a),i={id:a,organizationId:e,universalCategoryId:"",customName:t.name,customDescription:t.description,customEscalationPath:t.escalationPath,customExamples:t.examples||[],customSeverity:t.severity||"medium",isCustomCategory:!0,isDisabled:!1,createdAt:new Date,updatedAt:new Date};return await D(r,i),this.categoryCache.delete(e),t.name,a}catch(a){throw V.error("[DataService] Error creating custom category:",a),a}}static async disableCategory(e,t){try{const a=h(K,"organizations",e,"categories",t),r={organizationId:e,universalCategoryId:t,isDisabled:!0,isCustomCategory:!1,updatedAt:new Date};await D(a,r,{merge:!0}),this.categoryCache.delete(e)}catch(a){throw V.error("[DataService] Error disabling category:",a),a}}static convertUniversalToWarningCategory(e,t){return{id:e.id,organizationId:t,name:e.name,description:e.description,severity:this.mapSeverityToLegacy(e.severity),escalationPath:e.escalationPath,legalRequirements:e.proceduralRequirements,examples:e.commonExamples,defaultValidityPeriod:e.defaultValidityPeriod,isActive:!0,createdAt:new Date,updatedAt:new Date}}static convertUniversalToWarningCategories(e){return xe.map(t=>this.convertUniversalToWarningCategory(t,e))}static mapSeverityToLegacy(e){return{minor:"low",serious:"medium",gross_misconduct:"high"}[e]||"medium"}static async getOrganization(e){try{const t=h(K,Ne,e),a=await y(t);return a.exists()?{id:a.id,...a.data(),createdAt:this.convertOptionalDate(a.data().createdAt),updatedAt:this.convertOptionalDate(a.data().updatedAt)}:null}catch(t){return V.error("[DataService] Error getting organization:",t),null}}static async createOrganization(e){try{const t=e.id?h(K,Ne,e.id):h(w(K,Ne)),a={...e,updatedAt:E(),...e.id?{}:{createdAt:E()}};return await D(t,a),await this.logAuditEvent("ORGANIZATION_CREATED",{organizationId:t.id}),t.id}catch(t){throw V.error("[DataService] Error creating organization:",t),t}}static async updateOrganization(e,t){try{const a=h(K,Ne,e);await A(a,{...t,updatedAt:E()}),await this.logAuditEvent("ORGANIZATION_UPDATED",{organizationId:e,updates:t})}catch(a){throw V.error("[DataService] Error updating organization:",a),a}}static async getEmployeesByOrganization(e){try{const t=w(K,"organizations",e,"employees"),a=v(t,S("isActive","==",!0),x("profile.lastName"),x("profile.firstName"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt),profile:{...e.data().profile,startDate:this.convertDate(e.data().profile?.startDate)},employment:{...e.data().employment,startDate:this.convertDate(e.data().employment?.startDate),endDate:this.convertOptionalDate(e.data().employment?.endDate),probationEndDate:this.convertOptionalDate(e.data().employment?.probationEndDate)}}))}catch(t){return V.error("[DataService] Error getting employees:",t),[]}}static async getEmployeesByManager(e,t){try{return(await this.getEmployeesByOrganization(t)).filter(t=>t.employment?.managerId===e&&t.isActive)}catch(a){throw V.error("[DataService] Failed to get employees by manager:",a),a}}static async getEmployee(e){try{const t=h(K,Re,e),a=await y(t);return a.exists()?{id:a.id,...a.data(),createdAt:this.convertDate(a.data().createdAt),updatedAt:this.convertDate(a.data().updatedAt),profile:{...a.data().profile,startDate:this.convertDate(a.data().profile?.startDate)},employment:{...a.data().employment,startDate:this.convertDate(a.data().employment?.startDate),endDate:this.convertOptionalDate(a.data().employment?.endDate),probationEndDate:this.convertOptionalDate(a.data().employment?.probationEndDate)}}:null}catch(t){return V.error("[DataService] Error getting employee:",t),null}}static async saveEmployee(e,t){try{Object.keys(e),e.employeeNumber,e.firstName,e.lastName;const a=e.id?h(K,Re,e.id):h(w(K,Re)),r={...e,organizationId:t,updatedAt:E(),...e.id?{}:{createdAt:E()}};return await D(a,r),this.logAuditEvent(e.id?"EMPLOYEE_UPDATED":"EMPLOYEE_CREATED",{employeeId:a.id,organizationId:t}).catch(e=>V.warn("Audit logging failed:",e)),a.id}catch(a){throw V.error("[DataService] Error saving employee:",a),a}}static async archiveEmployee(e,t){try{const a=h(K,Re,e);await A(a,{isActive:!1,archivedAt:E(),updatedAt:E()}),await this.logAuditEvent("EMPLOYEE_ARCHIVED",{employeeId:e,organizationId:t})}catch(a){throw V.error("[DataService] Error archiving employee:",a),a}}static async restoreEmployee(e,t){try{const a=h(K,Re,e);await A(a,{isActive:!0,archivedAt:null,updatedAt:E()}),await this.logAuditEvent("EMPLOYEE_RESTORED",{employeeId:e,organizationId:t})}catch(a){throw V.error("[DataService] Error restoring employee:",a),a}}static async getWarningsByOrganization(e,t){try{const a=w(K,"organizations",e,"warnings");let r=v(a,x("issueDate","desc"));t&&(r=v(r,I(t)));const i=(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),deliveryDate:this.convertOptionalDate(e.data().deliveryDate),signatureDate:this.convertOptionalDate(e.data().signatureDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)})),n=[...new Set(i.map(e=>e.employeeId).filter(e=>e))],o=[...new Set(i.map(e=>e.categoryId).filter(e=>e))],[s,c]=await Promise.all([this.getBatchEmployees(n,e),this.getBatchWarningCategories(o,e)]),l=new Map;s.forEach(e=>{e&&l.set(e.id,{firstName:e.profile?.firstName||"Unknown",lastName:e.profile?.lastName||"Employee",employeeNumber:e.employeeNumber||"N/A",department:e.employment?.department||"Unknown"})});const d=new Map;return c.forEach(e=>{e&&d.set(e.id,e.name)}),i.map(e=>{const t=l.get(e.employeeId),a=d.get(e.categoryId);return{...e,employeeName:t?`${t.firstName} ${t.lastName}`:"Unknown Employee",employeeNumber:t?.employeeNumber||"Unknown",department:t?.department||"Unknown",category:a||"Unknown Category"}})}catch(a){return V.error("[DataService] Error getting warnings:",a),[]}}static async getWarningsForEmployee(e,t){try{const a=w(K,"organizations",t,"warnings"),r=v(a,S("employeeId","==",e),x("issueDate","desc"));return(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),deliveryDate:this.convertOptionalDate(e.data().deliveryDate),signatureDate:this.convertOptionalDate(e.data().signatureDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(a){return V.error("[DataService] Error getting employee warnings:",a),[]}}static async getActiveWarningsForEmployee(e,t){try{const a=w(K,"organizations",t,"warnings"),r=new Date,i=v(a,S("employeeId","==",e),S("isActive","==",!0),S("expiryDate",">",r),x("expiryDate","desc"),x("issueDate","desc"));return(await f(i)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),deliveryDate:this.convertOptionalDate(e.data().deliveryDate),signatureDate:this.convertOptionalDate(e.data().signatureDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(a){return V.error("[DataService] Error getting active employee warnings:",a),[]}}static async getWarning(e,t){try{const a=h(K,"organizations",t,"warnings",e),r=await y(a);return r.exists()?{id:r.id,...r.data(),issueDate:this.convertDate(r.data().issueDate),expiryDate:this.convertDate(r.data().expiryDate),incidentDate:this.convertDate(r.data().incidentDate),deliveryDate:this.convertOptionalDate(r.data().deliveryDate),signatureDate:this.convertOptionalDate(r.data().signatureDate),createdAt:this.convertDate(r.data().createdAt),updatedAt:this.convertDate(r.data().updatedAt)}:null}catch(a){return V.error("[DataService] Error getting warning:",a),null}}static async saveWarning(e,t){try{const a=e.id?h(K,"organizations",t,"warnings",e.id):h(w(K,"organizations",t,"warnings")),r={...e,organizationId:t,updatedAt:E(),...e.id?{}:{createdAt:E()}};return await D(a,r),await this.logAuditEvent(e.id?"WARNING_UPDATED":"WARNING_CREATED",{warningId:a.id,organizationId:t,employeeId:e.employeeId}),V.success(33682),a.id}catch(a){throw V.error("‚ùå [SAVE] Error saving warning:",a),a}}static async updateWarningStatus(e,t,a){try{const r=h(K,"organizations",a,"warnings",e);await A(r,{status:t,updatedAt:E()}),await this.logAuditEvent("WARNING_STATUS_UPDATED",{warningId:e,organizationId:a,newStatus:t})}catch(r){throw V.error("[DataService] Error updating warning status:",r),r}}static async markWarningDelivered(e,t,a,r){try{const i=h(K,"organizations",t,"warnings",e);await A(i,{isDelivered:!0,deliveryDate:E(),deliveryMethod:a,deliveryDetails:r,updatedAt:E()}),await this.logAuditEvent("WARNING_DELIVERED",{warningId:e,organizationId:t,deliveryMethod:a,deliveryDetails:r})}catch(i){throw V.error("[DataService] Error marking warning as delivered:",i),i}}static async createUser(e){try{if(!e.organizationId)throw new Error("Organization ID is required for user creation");const t=e.id?h(K,"organizations",e.organizationId,"users",e.id):h(w(K,"organizations",e.organizationId,"users")),a={...e,createdAt:E(),updatedAt:E()};return await D(t,a),await this.logAuditEvent("USER_CREATED",{userId:t.id,organizationId:e.organizationId}),t.id}catch(t){throw V.error("[DataService] Error creating user:",t),t}}static async getUser(e,t){try{const a=h(K,"organizations",t,"users",e),r=await y(a);return r.exists()?{id:r.id,...r.data(),createdAt:this.convertDate(r.data().createdAt),lastLogin:this.convertOptionalDate(r.data().lastLogin)}:null}catch(a){return V.error("[DataService] Error getting user:",a),null}}static async getUsersByOrganization(e){try{const t=w(K,"organizations",e,"users"),a=v(t,S("isActive","==",!0),x("lastName"),x("firstName"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),lastLogin:this.convertOptionalDate(e.data().lastLogin)}))}catch(t){return V.error("[DataService] Error getting users:",t),[]}}static async updateUser(e,t,a){try{const r=h(K,"organizations",a,"users",e);await A(r,{...t,updatedAt:E()}),await this.logAuditEvent("USER_UPDATED",{userId:e,organizationId:t.organizationId})}catch(r){throw V.error("[DataService] Error updating user:",r),r}}static async deactivateUser(e,t){try{const r=h(K,"organizations",t,"users",e);await A(r,{isActive:!1,updatedAt:E()});try{await le.setUserActiveStatus(e,!1)}catch(a){V.error("‚ùå Failed to update UserOrgIndex active status:",a)}await this.logAuditEvent("USER_DEACTIVATED",{userId:e,organizationId:t})}catch(r){throw V.error("[DataService] Error deactivating user:",r),r}}static async createDocumentTemplate(e){try{if(!e.organizationId)throw new Error("Organization ID is required for template creation");const t=e.id?h(K,"organizations",e.organizationId,"templates",e.id):h(w(K,"organizations",e.organizationId,"templates")),a={...e,createdAt:E(),updatedAt:E()};return await D(t,a),await this.logAuditEvent("TEMPLATE_CREATED",{templateId:t.id,organizationId:e.organizationId}),t.id}catch(t){throw V.error("[DataService] Error creating template:",t),t}}static async getDocumentTemplates(e){try{const t=w(K,"organizations",e,"templates"),a=v(t,S("isActive","==",!0),x("name"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(t){return V.error("[DataService] Error getting templates:",t),[]}}static async updateDocumentTemplate(e,t,a){try{const r=h(K,"organizations",a,"templates",e);await A(r,{...t,updatedAt:E()}),await this.logAuditEvent("TEMPLATE_UPDATED",{templateId:e,organizationId:t.organizationId})}catch(r){throw V.error("[DataService] Error updating template:",r),r}}static async getEscalationRules(e){try{const t=w(K,"organizations",e,"escalationRules"),a=v(t,S("isActive","==",!0),x("category"));return(await f(a)).docs.map(e=>({id:e.id,...e.data()}))}catch(t){return V.error("[DataService] Error getting escalation rules:",t),[]}}static async createEscalationRule(e,t){try{const a=h(w(K,"organizations",t,"escalationRules")),r={...e,organizationId:t,createdAt:E(),updatedAt:E()};return await D(a,r),await this.logAuditEvent("ESCALATION_RULE_CREATED",{ruleId:a.id,organizationId:t}),a.id}catch(a){throw V.error("[DataService] Error creating escalation rule:",a),a}}static async getOrganizationStats(e){try{const[t,a,r]=await Promise.all([this.getEmployeesByOrganization(e),this.getWarningsByOrganization(e,100),this.getActiveWarnings(e)]),i=new Date,n=new Date(i.getTime()-2592e6),o=a.filter(e=>e.issueDate>=n),s=a.reduce((e,t)=>(e[t.level]=(e[t.level]||0)+1,e),{});return{totalEmployees:t.length,activeEmployees:t.filter(e=>e.isActive).length,totalWarnings:a.length,activeWarnings:r.length,recentWarnings:o.length,warningsByLevel:s,lastUpdated:i}}catch(t){return V.error("[DataService] Error getting organization stats:",t),{totalEmployees:0,activeEmployees:0,totalWarnings:0,activeWarnings:0,recentWarnings:0,warningsByLevel:{},lastUpdated:new Date}}}static async getActiveWarnings(e){try{const t=w(K,"organizations",e,"warnings"),a=new Date,r=v(t,S("isActive","==",!0),S("expiryDate",">",a));return(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:this.convertDate(e.data().issueDate),expiryDate:this.convertDate(e.data().expiryDate),incidentDate:this.convertDate(e.data().incidentDate),createdAt:this.convertDate(e.data().createdAt),updatedAt:this.convertDate(e.data().updatedAt)}))}catch(t){return V.error("[DataService] Error getting active warnings:",t),[]}}static async createAuditLog(e){try{await z(w(K,_e),{...e,timestamp:E(),userId:G.currentUser?.uid||"system"})}catch(t){V.error("[DataService] Error creating audit log:",t)}}static async logAuditEvent(e,t){}static async getUserIP(){try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip}catch{return"unknown"}}static async getAuditLogs(e,t=50){try{const a=w(K,_e),r=v(a,S("data.organizationId","==",e),x("timestamp","desc"),I(t));return(await f(r)).docs.map(e=>({id:e.id,...e.data(),timestamp:this.convertDate(e.data().timestamp)}))}catch(a){return V.error("[DataService] Error getting audit logs:",a),[]}}static validateWarningLevel(e,t,a){try{return t.escalationPath.includes(a)?{isValid:!0}:{isValid:!1,reason:`${a} is not valid for category "${t.name}"`,suggestedLevel:t.escalationPath[0]}}catch(r){return V.error("[DataService] Error validating warning level:",r),{isValid:!1,reason:"Validation error occurred"}}}static async employeeExists(e){try{return null!==await this.getEmployee(e)}catch(t){return V.error("[DataService] Error checking employee existence:",t),!1}}static async organizationExists(e){try{return null!==await this.getOrganization(e)}catch(t){return V.error("[DataService] Error checking organization existence:",t),!1}}static async employeeNumberExists(e,t){try{const a=w(K,"organizations",e,"employees"),r=v(a,S("profile.employeeNumber","==",t));return!(await f(r)).empty}catch(a){return V.error("[DataService] Error checking employee number existence:",a),!1}}static async getAllEmployeeNumbers(e){try{const t=w(K,Re),a=v(t,S("organizationId","==",e));return(await f(a)).docs.map(e=>e.data().profile?.employeeNumber).filter(e=>e&&"string"==typeof e)}catch(t){return V.error("[DataService] Error getting employee numbers:",t),[]}}static async generateNextEmployeeNumber(e,t="EMP001",a="",r=1){try{const i=await this.getAllEmployeeNumbers(e);let n=r-1;i.forEach(e=>{const t=e.match(/(\d+)$/);if(t){const e=parseInt(t[1],10);e>n&&(n=e)}});const o=n+1;switch(t){case"EMP001":default:return`EMP${o.toString().padStart(3,"0")}`;case"E001":return`E${o.toString().padStart(3,"0")}`;case"001":return o.toString().padStart(3,"0");case"custom":return`${a}${o.toString().padStart(3,"0")}`}}catch(i){return V.error("[DataService] Error generating employee number:",i),`EMP${Date.now().toString().slice(-3)}`}}static async validateEmployeeNumber(e,t,a){try{if(!t||0===t.trim().length)return{isValid:!1,isAvailable:!1,message:"Employee number is required"};if(t.length<2)return{isValid:!1,isAvailable:!1,message:"Employee number must be at least 2 characters"};const r=await this.employeeNumberExists(e,t);if(r&&a){const r=w(K,Re),i=v(r,S("organizationId","==",e),S("profile.employeeNumber","==",t)),n=await f(i);if(!n.docs.some(e=>e.id===a)){return{isValid:!0,isAvailable:!1,suggestions:[await this.generateNextEmployeeNumber(e,"EMP001"),await this.generateNextEmployeeNumber(e,"E001"),await this.generateNextEmployeeNumber(e,"001")],message:"Employee number already exists"}}}else if(r){return{isValid:!0,isAvailable:!1,suggestions:[await this.generateNextEmployeeNumber(e,"EMP001"),await this.generateNextEmployeeNumber(e,"E001"),await this.generateNextEmployeeNumber(e,"001")],message:"Employee number already exists"}}return{isValid:!0,isAvailable:!0,message:"Employee number is available"}}catch(r){return V.error("[DataService] Error validating employee number:",r),{isValid:!1,isAvailable:!1,message:"Error validating employee number"}}}static async cleanupExpiredWarnings(e){try{const t=w(K,Oe),a=new Date;let r=v(t,S("isActive","==",!0),S("expiryDate","<",a));e&&(r=v(t,S("organizationId","==",e),S("isActive","==",!0),S("expiryDate","<",a)));const i=await f(r),n=O(K);return i.docs.forEach(e=>{n.update(e.ref,{isActive:!1,expiredAt:E(),updatedAt:E()})}),await n.commit(),e&&await this.logAuditEvent("WARNINGS_CLEANUP",{organizationId:e,expiredCount:i.docs.length}),i.docs.length,i.docs.length}catch(t){return V.error("[DataService] Error cleaning up expired warnings:",t),0}}static async getSystemHealthMetrics(){try{return{status:"healthy",timestamp:new Date,services:{firestore:"operational",auth:"operational",storage:"operational"}}}catch(e){return V.error("[DataService] Error getting system health:",e),{status:"degraded",timestamp:new Date,error:e instanceof Error?e.message:"Unknown error"}}}static getIndustryCategories(e,t){return this.convertUniversalToWarningCategories(t)}static async createWarningCategory(e){try{const t=e.organizationId;if(!t)throw new Error("Organization ID is required for creating categories");const a=e.id?h(K,"organizations",t,"categories",e.id):h(w(K,"organizations",t,"categories")),r={...e,createdAt:E(),updatedAt:E()};return await D(a,r),await this.logAuditEvent("WARNING_CATEGORY_CREATED",{categoryId:a.id,organizationId:e.organizationId}),e.organizationId&&this.categoryCache.delete(e.organizationId),a.id}catch(t){throw V.error("[DataService] Error creating warning category:",t),t}}static async bulkCreateEmployees(e,t){try{const a=O(K),r=[];for(const i of e){const e=h(w(K,Re));r.push(e.id),a.set(e,{...i,organizationId:t,createdAt:E(),updatedAt:E()})}return await a.commit(),await this.logAuditEvent("EMPLOYEES_BULK_CREATED",{organizationId:t,count:e.length,employeeIds:r}),r}catch(a){throw V.error("[DataService] Error bulk creating employees:",a),a}}static async bulkUpdateWarningStatuses(e,t,a){try{const r=O(K);for(const a of e){const e=h(K,Oe,a);r.update(e,{status:t,updatedAt:E()})}await r.commit(),await this.logAuditEvent("WARNINGS_BULK_STATUS_UPDATE",{organizationId:a,warningIds:e,newStatus:t,count:e.length})}catch(r){throw V.error("[DataService] Error bulk updating warning statuses:",r),r}}static async loadOrganizations(){try{const e=w(K,Ne),t=v(e,x("createdAt","desc")),a=(await f(t)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}));return V.success(`‚úÖ Loaded ${a.length} organizations successfully`),a}catch(e){throw V.error("[DataService] Error loading organizations:",e),e}}static async getBatchEmployees(e,t){try{if(!e.length)return[];const a=[],r=10;for(let i=0;i<e.length;i+=r){const n=e.slice(i,i+r),o=w(K,Re),s=v(o,S("organizationId","==",t),S("__name__","in",n)),c=(await f(s)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}));a.push(...c)}return V.success(65113),a}catch(a){return V.error("[DataService] Error in batch employee fetch:",a),[]}}static async getBatchWarningCategories(e,t){try{if(!e.length)return[];const a=[],r=10;for(let i=0;i<e.length;i+=r){const n=e.slice(i,i+r),o=w(K,"organizations",t,"categories"),s=v(o,S("__name__","in",n)),c=(await f(s)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}));a.push(...c)}return V.success(66603),a}catch(a){return V.error("[DataService] Error in batch category fetch:",a),[]}}static async getPaginatedEmployees(e,t=50,a){try{const r=w(K,Re);let i=v(r,S("organizationId","==",e),S("isActive","==",!0),x("profile.lastName"),x("profile.firstName"),I(t+1));if(a){const n=await y(h(K,Re,a));n.exists()&&(i=v(r,S("organizationId","==",e),S("isActive","==",!0),x("profile.lastName"),x("profile.firstName"),N(n),I(t+1)))}const n=(await f(i)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)})),o=n.length>t,s=o?n.slice(0,t):n,c=s.length>0?s[s.length-1].id:void 0;return V.success(68710),{employees:s,hasMore:o,lastId:c}}catch(r){return V.error("[DataService] Error in paginated employee fetch:",r),{employees:[],hasMore:!1}}}static async updateWithOptimisticLocking(e,t,a,r=0){try{const i=h(K,e,t),n=await y(i);if(!n.exists())return{success:!1,error:"Document not found"};const o=n.data().version||0;if(o!==r)return{success:!1,error:`Document was modified by another user. Expected version ${r}, found ${o}`};const s=o+1;return await A(i,{...a,version:s,updatedAt:E()}),V.success(70248),{success:!0,newVersion:s}}catch(i){return V.error("[DataService] Optimistic locking error:",i),{success:!1,error:i instanceof Error?i.message:"Unknown error"}}}static async createReseller(e){try{const t=`reseller_${Date.now()}`,a={...e,id:t,createdAt:E(),updatedAt:E()};return await D(h(K,"resellers",t),a),V.success(`‚úÖ Reseller created: ${t}`),t}catch(t){throw V.error("‚ùå Failed to create reseller:",t),t}}static async updateReseller(e,t){try{await A(h(K,"resellers",e),{...t,updatedAt:E()}),V.success(`‚úÖ Reseller updated: ${e}`)}catch(a){throw V.error("‚ùå Failed to update reseller:",a),a}}static async getReseller(e){try{const t=h(K,"resellers",e),a=await y(t);return a.exists()?{id:a.id,...a.data(),createdAt:this.convertOptionalDate(a.data().createdAt),updatedAt:this.convertOptionalDate(a.data().updatedAt)}:null}catch(t){throw V.error("‚ùå Failed to get reseller:",t),t}}static async getResellerClients(e){try{const t=w(K,Ne),a=v(t,S("resellerId","==",e),x("createdAt","desc")),r=(await f(a)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}));return V.success(`üìä Loaded ${r.length} clients for reseller ${e}`),r}catch(t){throw V.error("‚ùå Failed to get reseller clients:",t),t}}static async createSubscription(e){try{const t=`sub_${Date.now()}`,a={...e,id:t,createdAt:E(),updatedAt:E()};return await D(h(K,"subscriptions",t),a),V.success(`‚úÖ Subscription created: ${t}`),t}catch(t){throw V.error("‚ùå Failed to create subscription:",t),t}}static async updateSubscription(e,t){try{await A(h(K,"subscriptions",e),{...t,updatedAt:E()}),V.success(`‚úÖ Subscription updated: ${e}`)}catch(a){throw V.error("‚ùå Failed to update subscription:",a),a}}static async getOrganizationSubscription(e){try{const t=w(K,"subscriptions"),a=v(t,S("organizationId","==",e)),r=await f(a);if(r.empty)return null;const i=r.docs[0];return{id:i.id,...i.data(),createdAt:this.convertOptionalDate(i.data().createdAt),updatedAt:this.convertOptionalDate(i.data().updatedAt)}}catch(t){throw V.error("‚ùå Failed to get subscription:",t),t}}static async createCommission(e){try{const t=e.id||`comm_${Date.now()}`,a={...e,id:t,createdAt:E(),updatedAt:E()};return await D(h(K,"commissions",t),a),V.success(`üí∞ Commission recorded: ${t}`),t}catch(t){throw V.error("‚ùå Failed to create commission:",t),t}}static async getResellerCommissions(e,t){try{const a=w(K,"commissions");let r=v(a,S("resellerId","==",e),x("createdAt","desc"));t&&(r=v(r,I(t)));const i=await f(r);return i.docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}))}catch(a){throw V.error("‚ùå Failed to get reseller commissions:",a),a}}static async updateOrganizationBilling(e,t){try{await A(h(K,Ne,e),{...t,updatedAt:E()}),V.success(`üí≥ Organization billing updated: ${e}`)}catch(a){throw V.error("‚ùå Failed to update organization billing:",a),a}}static async getOrganizationsWithBilling(){try{const e=w(K,Ne),t=v(e,x("createdAt","desc")),a=(await f(t)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}));for(const r of a){const e=await this.getOrganizationSubscription(r.id);e&&(r.subscription=e)}return V.success(`üìä Loaded ${a.length} organizations with billing`),a}catch(e){throw V.error("‚ùå Failed to load organizations with billing:",e),e}}static async createCommissionReport(e){try{const t=e.id||`report_${e.resellerId}_${e.month}`,a={...e,id:t,createdAt:E(),updatedAt:E()};return await D(h(K,"commissionReports",t),a),V.success(`üìÑ Commission report created: ${t}`),t}catch(t){throw V.error("‚ùå Failed to create commission report:",t),t}}static async getPendingCommissionReports(){try{const e=w(K,"commissionReports"),t=v(e,S("payoutStatus","==","pending"),x("createdAt","asc")),a=await f(t);return a.docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}))}catch(e){throw V.error("‚ùå Failed to get pending commission reports:",e),e}}static async assignResellerToOrganization(e,t){try{await this.updateOrganizationBilling(e,{resellerId:t});const a=await this.getReseller(t);if(a){const r=[...a.clientIds||[],e];await this.updateReseller(t,{clientIds:r,totalClientsAcquired:T(1)})}V.success(`ü§ù Reseller ${t} assigned to organization ${e}`)}catch(a){throw V.error("‚ùå Failed to assign reseller to organization:",a),a}}static async getAllResellers(){try{const e=v(w(K,"resellers"),x("createdAt","desc"));return(await f(e)).docs.map(e=>({id:e.id,...e.data(),createdAt:this.convertOptionalDate(e.data().createdAt),updatedAt:this.convertOptionalDate(e.data().updatedAt)}))}catch(e){throw V.error("Failed to get all resellers:",e),e}}static async getResellerDeployments(e,t){try{const a=v(w(K,"resellerDeployments"),S("resellerId","==",e),S("deployedAt",">=",t),x("deployedAt","desc"));return(await f(a)).docs.map(e=>({id:e.id,...e.data(),deployedAt:e.data().deployedAt?.toDate()||new Date,createdAt:e.data().createdAt?.toDate()||new Date}))}catch(a){return V.error("Failed to get reseller deployments:",a),[]}}static async logResellerDeployment(e){try{await z(w(K,"resellerDeployments"),{...e,createdAt:e.deployedAt})}catch(t){V.error("Failed to log reseller deployment:",t)}}}class $e{static simplifyWarning(e){return e.id,e.issueDate,e.incidentDate,{id:e.id||"",level:e.level,category:e.category||"Unknown Category",description:e.description||e.title||"No description",issueDate:e.issueDate,incidentDate:e.incidentDate,employeeName:e.employeeName,employeeNumber:e.employeeNumber}}static simplifyWarnings(e){return e.map(e=>this.simplifyWarning(e))}static async getEscalationRecommendation(e,t,a,r,i){try{let n,o=null;if(i&&r)V.success("‚ö°‚ö° [ANTICIPATORY] Using preloaded warnings AND category - instant response!"),n=i,o=r;else if(i){if(V.success("‚ö° [ANTICIPATORY] Using preloaded warnings, fetching category only"),n=i,a){const e=await ne.queryDocuments(a,"categories",[]);e.documents&&e.documents.length>0&&(o=e.documents.find(e=>e.id===t))}}else if(r)n=await this.getActiveWarnings(e,a),o=r;else{const[r,i]=await Promise.all([this.getActiveWarnings(e,a),a?ne.queryDocuments(a,"categories",[]):Promise.resolve({documents:[]})]);n=r,i.documents&&i.documents.length>0&&(o=i.documents.find(e=>e.id===t))}let s=null,c=!1,l=null;o?.escalationPath&&(s=o.escalationPath,c=!0),c||(l=Ie(t),l&&(s=l.escalationPath||["counselling","verbal","first_written","final_written"],c=!0));const d=o||l;if(!c||!s)return V.warn("‚ö†Ô∏è [ESCALATION] Category not found in organization or universal categories, using fallback"),this.getFallbackRecommendation(t,a);const u=n.filter(e=>e.categoryId===t);n.length,u.length;const g=s,m=this.determineSuggestedLevel(u,g),p="hr_intervention"===m,h=p?"final_written":m,y={suggestedLevel:h,recommendedLevel:p?"HR INTERVENTION REQUIRED":ze(h),reason:p?this.generateHRInterventionReason(u,d):this.generateEscalationReason(u,h,d),requiresHRIntervention:p,interventionReason:p?`Employee has active final written warning for ${d?.name||"this category"}. Next offense requires manual HR decision through dedicated intervention module.`:void 0,interventionLevel:p?"urgent":void 0,activeWarnings:this.simplifyWarnings(u),escalationPath:g,isEscalation:u.length>0,category:d?.name||"Unknown Category",categoryId:d?.id||t,legalBasis:d?.lraSection||"Schedule 8 Item 3",legalRequirements:d?.proceduralRequirements||[],warningCount:n.length,categoryWarningCount:u.length,nextExpiryDate:this.calculateNextExpiryDate(m,d?.defaultValidityPeriod||6),examples:d?.commonExamples||[],explanation:d?.escalationRationale||"Progressive discipline according to LRA Schedule 8",previousWarnings:this.simplifyWarnings(u)};return V.success(7929),y}catch(n){return V.error("‚ùå [ESCALATION] Error generating recommendation:",n),this.getFallbackRecommendation(t,a)}}static determineSuggestedLevel(e,t){if(0===e.length){const e=t[0]||"counselling";return e}if(e.some(e=>"final_written"===e.level))return V.warn("üö® [HR INTERVENTION] Employee has final written warning - HR intervention required"),"hr_intervention";let a=t[0]||"counselling",r=-1,i=!1;for(const s of e){const e=t.indexOf(s.level);e>r&&(r=e,a=s.level,i=s.wasOverridden||!1)}const n=t.indexOf(a)+1;if(n>=t.length){const e="final_written";return e}const o=t[n];return o}static generateEscalationReason(e,t,a){if(0===e.length)return`First incident of ${a?.name||"this category"}. Starting with ${ze(t)} follows standard progressive discipline procedures.`;const r=e.length,i=e[0],n=Math.floor((Date.now()-i.issueDate.getTime())/864e5),o=e.some(e=>e.wasOverridden)?" Note: Previous warnings include manager-overridden levels.":"";return`Employee has ${r} active warning${r>1?"s":""} on record. Most recent warning was issued ${n} days ago. Progressive discipline policy requires escalation to ${ze(t)}.${o}`}static generateHRInterventionReason(e,t){const a=e.find(e=>"final_written"===e.level);if(!a)return`üö® URGENT: Employee requires HR intervention for ${t?.name||"this category"} violation.`;const r=Math.floor((Date.now()-a.issueDate.getTime())/864e5),i=e.length;return`üö® URGENT HR INTERVENTION REQUIRED: Employee has active final written warning for ${t?.name||"this category"} (issued ${r} days ago) and has committed another offense. Total active warnings: ${i}. HR must use dedicated intervention module to decide next steps. System cannot escalate beyond final written warning.`}static calculateNextExpiryDate(e,t){const a="counselling"===e?3:"verbal"===e?6:"final_written"===e?12:t,r=new Date;return r.setMonth(r.getMonth()+a),r}static assessCCMAReadiness(e,t,a){return e.length>=2&&"final_written"===a?"high":e.length>=1?"medium":"low"}static async getActiveWarnings(t,a){try{if(!a){V.warn("‚ö†Ô∏è [WARNINGS] No organizationId provided, using DataService fallback");a=(await Te.getOrganization()).id}const r=await e(()=>import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Z),[]),{getFunctions:i,httpsCallable:n}=r,o=n(i(),"getActiveWarningsServerSide"),s=await o({employeeId:t,organizationId:a});if(s.data&&"object"==typeof s.data&&"success"in s.data&&s.data.success){const e=s.data,t=e.warnings.map(e=>({...e,issueDate:new Date(e.issueDate),expiryDate:new Date(e.expiryDate),incidentDate:new Date(e.incidentDate),createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),deliveryDate:e.deliveryDate?new Date(e.deliveryDate):void 0,signatureDate:e.signatureDate?new Date(e.signatureDate):void 0}));return V.success(`üìã [WARNINGS] Retrieved ${t.length} active warnings using SERVER time (${e.serverTime})`),t}return V.warn("‚ö†Ô∏è [WARNINGS] Server function returned unexpected result, using fallback"),[]}catch(r){V.error("‚ùå [WARNINGS] Error getting active warnings from server, using client fallback:",r);try{const e=w(K,"organizations",a,"warnings"),r=v(e,S("employeeId","==",t),S("isActive","==",!0),x("issueDate","desc")),i=(await f(r)).docs.map(e=>({id:e.id,...e.data(),issueDate:e.data().issueDate?.toDate()||new Date,expiryDate:e.data().expiryDate?.toDate()||new Date,incidentDate:e.data().incidentDate?.toDate()||new Date,createdAt:e.data().createdAt?.toDate()||new Date,updatedAt:e.data().updatedAt?.toDate()||new Date}));return V.warn(`‚ö†Ô∏è [WARNINGS] Fallback succeeded with ${i.length} warnings (client time)`),i}catch(i){return V.error("‚ùå [WARNINGS] Fallback also failed:",i),[]}}}static getFallbackRecommendation(e,t){const a="counselling";return{suggestedLevel:a,recommendedLevel:ze(a),reason:"Unable to analyze warning history - defaulting to counselling for safety",activeWarnings:[],escalationPath:["counselling","verbal","first_written","final_written"],isEscalation:!1,category:"General Misconduct",categoryId:e||"general",legalBasis:"LRA Section 188 - Fair reason and procedure",legalRequirements:["Ensure fair and consistent application of disciplinary procedures"],warningCount:0,nextExpiryDate:this.calculateNextExpiryDate(a,6),examples:["System error occurred - manual review required"],explanation:"System error occurred - defaulting to safest disciplinary option",previousWarnings:[],ccmaReadiness:"low",ccmaFactors:["Follow basic progressive discipline principles"]}}static normalizeWarningLevel(e){return{counselling:"counselling",counseling:"counselling",verbal:"verbal",verbal_warning:"verbal",first_written:"first_written",first_written_warning:"first_written",second_written:"second_written",second_written_warning:"second_written",final_written:"final_written",final_written_warning:"final_written"}[e.toLowerCase().replace(/\s+/g,"_")]||"counselling"}static async saveWarning(e,t){try{const a=e.id?h(K,"organizations",t,"warnings",e.id):h(w(K,"organizations",t,"warnings")),r=e.issueDate?"string"==typeof e.issueDate?new Date(e.issueDate):e.issueDate:new Date,i=e.incidentDate?"string"==typeof e.incidentDate?new Date(e.incidentDate):e.incidentDate:new Date,n=e.validityPeriod||6,o=new Date(r);o.setMonth(o.getMonth()+n);const s=e.reviewDate?e.reviewDate instanceof Date?_.fromDate(e.reviewDate):"string"==typeof e.reviewDate?_.fromDate(new Date(e.reviewDate)):e.reviewDate:void 0,c=e.improvementCommitments?e.improvementCommitments.map(e=>({commitment:e.commitment||"",timeline:e.timeline||"",completedDate:e.completedDate||null})):void 0,l={...e,organizationId:t,issueDate:_.fromDate(r),expiryDate:_.fromDate(o),incidentDate:_.fromDate(i),updatedAt:re.getServerTimestamp(),...e.id?{}:{createdAt:re.getServerTimestamp()},...e.employeeStatement&&{employeeStatement:e.employeeStatement},...e.expectedBehaviorStandards&&{expectedBehaviorStandards:e.expectedBehaviorStandards},...e.factsLeadingToDecision&&{factsLeadingToDecision:e.factsLeadingToDecision},...c&&{improvementCommitments:c},...s&&{reviewDate:s},...e.interventionDetails&&{interventionDetails:e.interventionDetails},...e.resourcesProvided&&{resourcesProvided:e.resourcesProvided},...e.trainingProvided&&{trainingProvided:e.trainingProvided}};return e.id?await A(a,l):await D(a,l),V.success(16339),a.id}catch(a){throw V.error("‚ùå [SAVE] Error saving warning:",a),a}}static async getWarningById(e){try{const t=await Te.getOrganization(),a=h(K,"organizations",t.id,"warnings",e),r=await y(a);if(!r.exists())return null;const i=r.data();return{id:r.id,...i,issueDate:i.issueDate?.toDate()||new Date,expiryDate:i.expiryDate?.toDate()||new Date,incidentDate:i.incidentDate?.toDate()||new Date,createdAt:i.createdAt?.toDate()||new Date,updatedAt:i.updatedAt?.toDate()||new Date,reviewDate:i.reviewDate?.toDate()||void 0,improvementCommitments:i.improvementCommitments?i.improvementCommitments.map(e=>({commitment:e.commitment||"",timeline:e.timeline||"",completedDate:e.completedDate?.toDate()||void 0})):void 0}}catch(t){return V.error("‚ùå [GET] Error getting warning by ID:",t),null}}static async getWarningsNeedingReview(e){try{const t=w(K,`organizations/${e}/warnings`),a=v(t,S("reviewDate","!=",null),S("reviewStatus","in",["due_soon","overdue","in_progress"]),x("reviewDate","asc"));return(await f(a)).docs.map(e=>{const t=e.data();return{id:e.id,...t,issueDate:t.issueDate?.toDate()||new Date,expiryDate:t.expiryDate?.toDate()||new Date,incidentDate:t.incidentDate?.toDate()||new Date,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?.toDate()||new Date,reviewDate:t.reviewDate?.toDate()||void 0,reviewCompletedDate:t.reviewCompletedDate?.toDate()||void 0,autoSatisfiedDate:t.autoSatisfiedDate?.toDate()||void 0,reviewLastChecked:t.reviewLastChecked?.toDate()||void 0}})}catch(t){throw V.error("‚ùå [REVIEW] Error getting warnings needing review:",t),t}}static async updateReviewStatus(e,t,a){try{const r=h(K,`organizations/${t}/warnings`,e),i={updatedAt:_.now()};a.reviewStatus&&(i.reviewStatus=a.reviewStatus),a.reviewCompletedDate&&(i.reviewCompletedDate=_.fromDate(a.reviewCompletedDate)),a.reviewCompletedBy&&(i.reviewCompletedBy=a.reviewCompletedBy),a.reviewCompletedByName&&(i.reviewCompletedByName=a.reviewCompletedByName),void 0!==a.reviewHODFeedback&&(i.reviewHODFeedback=a.reviewHODFeedback),void 0!==a.reviewHRNotes&&(i.reviewHRNotes=a.reviewHRNotes),a.reviewOutcome&&(i.reviewOutcome=a.reviewOutcome),void 0!==a.reviewNextSteps&&(i.reviewNextSteps=a.reviewNextSteps),a.autoSatisfiedDate&&(i.autoSatisfiedDate=_.fromDate(a.autoSatisfiedDate)),a.escalatedToWarningId&&(i.escalatedToWarningId=a.escalatedToWarningId),a.reviewLastChecked&&(i.reviewLastChecked=_.fromDate(a.reviewLastChecked)),await A(r,i)}catch(r){throw V.error("‚ùå [REVIEW] Error updating review status:",r),r}}static async markReviewSatisfactory(e,t,a,r,i){try{await this.updateReviewStatus(e,t,{reviewStatus:"completed_satisfactory",reviewCompletedDate:new Date,reviewCompletedBy:a,reviewCompletedByName:r,reviewHRNotes:i||"",reviewOutcome:"satisfactory",reviewLastChecked:new Date})}catch(n){throw V.error("‚ùå [REVIEW] Error marking review satisfactory:",n),n}}static async markReviewUnsatisfactory(e,t,a,r,i,n){try{await this.updateReviewStatus(e,t,{reviewStatus:"completed_unsatisfactory",reviewCompletedDate:new Date,reviewCompletedBy:a,reviewCompletedByName:r,reviewHRNotes:i,reviewOutcome:"unsatisfactory",reviewNextSteps:n,reviewLastChecked:new Date})}catch(o){throw V.error("‚ùå [REVIEW] Error marking review unsatisfactory:",o),o}}static async getReviewStatistics(e){try{const t=w(K,`organizations/${e}/warnings`),a=v(t,S("reviewDate","!=",null)),r=await f(a),i={pending:0,dueSoon:0,overdue:0,inProgress:0,completedSatisfactory:0,completedUnsatisfactory:0,autoSatisfied:0,escalated:0};return r.docs.forEach(e=>{switch(e.data().reviewStatus||"pending"){case"pending":i.pending++;break;case"due_soon":i.dueSoon++;break;case"overdue":i.overdue++;break;case"in_progress":i.inProgress++;break;case"completed_satisfactory":i.completedSatisfactory++;break;case"completed_unsatisfactory":i.completedUnsatisfactory++;break;case"auto_satisfied":i.autoSatisfied++;break;case"escalated":i.escalated++}}),i}catch(t){throw V.error("‚ùå [REVIEW] Error getting review statistics:",t),t}}}class ke{static{this.CACHE_DURATION=3e5}static{this.cache=new Map}static getCacheKey(e,t,a){return`${e}:${t}:${JSON.stringify(a||{})}`}static isValidCache(e){const t=this.cache.get(e);return!!t&&Date.now()-t.timestamp<this.CACHE_DURATION}static invalidateCache(e){for(const[t]of this.cache)t.includes(e)&&this.cache.delete(t)}static async getEmployeeProfile(e,t){try{const a=h(K,`organizations/${e}/employees/${t}`),r=await y(a);if(!r.exists())throw new Error(`Employee ${t} not found`);const i=r.data(),n=h(a,"summary","stats"),o=await y(n);return{...i,id:r.id,summary:o.exists()?o.data():void 0}}catch(a){throw V.error("‚ùå [NESTED] Failed to get employee profile:",a),a}}static async createWarning(e,t,a){try{const r=O(K),i=w(K,`organizations/${e}/employees/${t}/warnings`),n=h(i),o={...a,id:n.id,organizationId:e,employeeId:t,createdAt:new Date,updatedAt:new Date};if(r.set(n,o),!1!==o.isActive){const a=h(K,`organizations/${e}/indexes/activeWarnings`,n.id),i={id:n.id,employeeId:t,organizationId:e,type:"warning",title:`${o.level} - ${o.category}`,date:o.issueDate||new Date,status:o.status||"issued",priority:"final_written"===o.level?"high":"written"===o.level?"medium":"low",metadata:{level:o.level,category:o.category,employeeName:o.employeeName}};r.set(a,i)}return await this.updateEmployeeSummaryStats(r,e,t,"warning"),await r.commit(),this.invalidateCache(`warnings:${e}`),this.invalidateCache(`employee:${e}:${t}`),V.success(`‚úÖ [NESTED] Created warning ${n.id} for employee ${t}`),n.id}catch(r){throw V.error("‚ùå [NESTED] Failed to create warning:",r),r}}static async getEmployeeWarnings(e,t,a,r){try{let i=w(K,`organizations/${e}/employees/${t}/warnings`);a?.status&&(i=v(i,S("status","==",a.status))),a?.level&&(i=v(i,S("level","==",a.level))),void 0!==a?.isActive&&(i=v(i,S("isActive","==",a.isActive)));i=v(i,x(r?.orderField||"issueDate",r?.orderDirection||"desc")),r?.pageSize&&(i=v(i,I(r.pageSize))),r?.lastDoc&&(i=v(i,N(r.lastDoc)));const n=await f(i),o=n.docs.map(e=>({...e.data(),id:e.id})),s=!!r?.pageSize&&n.docs.length===r.pageSize,c=n.docs.length>0?n.docs[n.docs.length-1]:void 0;return o.length,{warnings:o,hasMore:s,lastDoc:c}}catch(i){throw V.error("‚ùå [NESTED] Failed to get employee warnings:",i),i}}static async getOrganizationWarnings(e,t,a){try{let r=R(K,"warnings");r=v(r,S("organizationId","==",e)),t?.status&&(r=v(r,S("status","==",t.status))),t?.level&&(r=v(r,S("level","==",t.level))),t?.employeeId&&(r=v(r,S("employeeId","==",t.employeeId)));r=v(r,x(a?.orderField||"issueDate",a?.orderDirection||"desc")),a?.pageSize&&(r=v(r,I(a.pageSize))),a?.lastDoc&&(r=v(r,N(a.lastDoc)));const i=await f(r),n=i.docs.map(e=>({...e.data(),id:e.id})),o=!!a?.pageSize&&i.docs.length===a.pageSize,s=i.docs.length>0?i.docs[i.docs.length-1]:void 0;return n.length,{warnings:n,hasMore:o,lastDoc:s}}catch(r){throw V.error("‚ùå [NESTED] Failed to get organization warnings:",r),r}}static async updateWarning(e,t,a,r){try{const i=O(K),n=h(K,`organizations/${e}/employees/${t}/warnings/${a}`);i.update(n,{...r,updatedAt:E()});const o=h(K,`organizations/${e}/indexes/activeWarnings/${a}`);if("archived"===r.status||!1===r.isActive)i.delete(o);else if(r.status||r.level){const e={};r.status&&(e.status=r.status),r.level&&(e.priority="final_written"===r.level?"high":"written"===r.level?"medium":"low",e.metadata={...e.metadata,level:r.level}),i.update(o,e)}(r.status||void 0!==r.isActive)&&await this.updateEmployeeSummaryStats(i,e,t,"warning"),await i.commit(),this.invalidateCache(`warnings:${e}`),this.invalidateCache(`employee:${e}:${t}`),V.success(`‚úÖ [NESTED] Updated warning ${a}`)}catch(i){throw V.error("‚ùå [NESTED] Failed to update warning:",i),i}}static async getActiveWarningsIndex(e,t){try{const a=this.getCacheKey("activeWarnings",e,{limit:t});if(this.isValidCache(a))return this.cache.get(a).data;let r=w(K,`organizations/${e}/indexes/activeWarnings`);r=v(r,x("date","desc")),t&&(r=v(r,t(t)));const i=(await f(r)).docs.map(e=>({...e.data(),id:e.id}));return this.cache.set(a,{data:i,timestamp:Date.now()}),i.length,i}catch(a){throw V.error("‚ùå [NESTED] Failed to get active warnings index:",a),a}}static async updateEmployeeSummaryStats(e,t,a,r){try{const i=h(K,`organizations/${t}/employees/${a}/summary`,"stats");e.set(i,{lastUpdated:E(),[`${r}LastActivity`]:E()},{merge:!0})}catch(i){V.error("‚ùå [NESTED] Failed to update employee summary:",i)}}static clearCache(){this.cache.clear()}}const Pe={useNestedDataStructure:!1,enableDualWrite:!1,useCollectionGroupQueries:!1,enableEmployeeSummaryStats:!1,useIndexCollections:!1};function Le(e){return Pe[e]}function We(){return Le("useNestedDataStructure")}function Fe(){return Le("enableDualWrite")}function je(){return Le("useCollectionGroupQueries")}function Ue(){return Le("useIndexCollections")}class Me extends Error{constructor(e,t,a){super(e),this.code=t,this.originalError=a,this.name="APIError"}}const Be=(e,t)=>{if(V.error(`API Error in ${e}:`,t),t instanceof Error)throw new Me(`${e} failed: ${t.message}`,"OPERATION_FAILED",t);throw new Me(`${e} failed with unknown error`,"UNKNOWN_ERROR",t)},He=e=>{if(null==e)return e;if(Array.isArray(e))return e.map(He).filter(e=>void 0!==e);if("object"==typeof e&&!(e instanceof Date)){const t={};return Object.keys(e).forEach(a=>{const r=e[a];void 0!==r&&(t[a]=He(r))}),t}return e},Ve={async getAll(e,t){try{const[t,a]=await Promise.all([se.loadWarnings(e),se.loadEmployees(e)]),r=t.documents,i=a.documents,n=r.map(e=>{const t=i.find(t=>t.id===e.employeeId);if(t){const a=t.profile?.firstName||"",r=t.profile?.lastName||"",i=`${a} ${r}`.trim()||e.employeeName||"Unknown";return{...e,employeeName:i,employeeLastName:r||e.employeeLastName||"",employeeNumber:t.profile?.employeeNumber||e.employeeNumber||"Unknown",employeeDepartment:t.employment?.department||e.employeeDepartment||"Unknown",employeePosition:t.employment?.position||e.employeePosition||"Unknown",department:t.employment?.department||e.department||"Unknown",position:t.employment?.position||e.position||"Unknown"}}return e}),o=n.filter(e=>!(!e.level||!e.description)&&("Unknown Employee"!==e.employeeName&&"Employee Not Selected"!==e.employeeName));return n.length,r.length,o.length,o}catch(a){Be("warnings.getAll",a)}},async getById(e,t){try{return await se.getWarning(t,e)}catch(a){Be("warnings.getById",a)}},async create(e){try{const a={id:e.id||"",organizationId:e.organizationId,employeeId:e.employeeId,categoryId:e.categoryId,category:e.categoryName||"Unknown",categoryName:e.categoryName||"Unknown",level:e.level||"verbal",employeeName:e.employeeName||"Unknown",employeeLastName:e.employeeLastName||"Employee",employeeNumber:e.employeeNumber||"Unknown",employeeDepartment:e.employeeDepartment||"Unknown",employeePosition:e.employeePosition||"Unknown",department:e.employeeDepartment||"Unknown",position:e.employeePosition||"Unknown",incidentDate:new Date(e.incidentDate),incidentTime:e.incidentTime,incidentLocation:e.incidentLocation,description:e.incidentDescription,issueDate:new Date(e.issueDate),expiryDate:new Date(e.expiryDate||Date.now()+30*(e.validityPeriod||6)*24*60*60*1e3),validityPeriod:e.validityPeriod||6,issuedBy:e.issuedBy||"",issuedByName:e.issuedByName||"",isActive:!0,status:"issued",...e.additionalNotes&&{additionalNotes:e.additionalNotes},...e.signatures&&{signatures:e.signatures},...e.disciplineRecommendation&&{disciplineRecommendation:He(e.disciplineRecommendation)},...e.pdfGeneratorVersion&&{pdfGeneratorVersion:e.pdfGeneratorVersion},...e.pdfTemplateVersion&&{pdfTemplateVersion:e.pdfTemplateVersion},...e.employeeStatement&&{employeeStatement:e.employeeStatement},...e.expectedBehaviorStandards&&{expectedBehaviorStandards:e.expectedBehaviorStandards},...e.factsLeadingToDecision&&{factsLeadingToDecision:e.factsLeadingToDecision},...e.actionSteps&&{actionSteps:e.actionSteps},...e.reviewDate&&{reviewDate:e.reviewDate},...e.reviewStatus&&{reviewStatus:e.reviewStatus},...e.reviewLastChecked&&{reviewLastChecked:e.reviewLastChecked},...e.interventionDetails&&{interventionDetails:e.interventionDetails},...e.resourcesProvided&&{resourcesProvided:e.resourcesProvided},audioRecording:e.audioRecording||{status:"required",processingStatus:"pending",error:"Audio recording not provided"},deliveryMethod:e.deliveryMethod||"email",createdAt:new Date,updatedAt:new Date};let r;if(We()){if(r=await ke.createWarning(e.organizationId,e.employeeId,a),V.success(`üìÅ [NESTED] Warning created: ${r}`),Fe())try{await $e.saveWarning(a,e.organizationId)}catch(t){V.warn("‚ö†Ô∏è [DUAL-WRITE] Failed to save to sharded structure:",t)}}else if(r=await $e.saveWarning(a,e.organizationId),V.success(`üìã [SHARD] Warning created: ${r}`),Fe())try{await ke.createWarning(e.organizationId,e.employeeId,{...a,id:r})}catch(t){V.warn("‚ö†Ô∏è [DUAL-WRITE] Failed to save to nested structure:",t)}return r}catch(t){Be("warnings.create",t)}},async update(e,t,a,r){try{const n=a||t.organizationId;if(!n)throw new Error("Organization ID required for warning update");if(We())if(r){if(await ke.updateWarning(n,r,e,t),V.success(`üìÅ [NESTED] Warning ${e} updated successfully`),Fe())try{await this.updateFlatStructure(e,t,n)}catch(i){V.warn("‚ö†Ô∏è [DUAL-WRITE] Failed to update sharded structure:",i)}}else V.warn("‚ö†Ô∏è [NESTED] Employee ID required for nested update, falling back to sharded structure"),await this.updateFlatStructure(e,t,n);else if(await this.updateFlatStructure(e,t,n),V.success(`üìã [SHARD] Warning ${e} updated successfully`),Fe()&&r)try{await ke.updateWarning(n,r,e,t)}catch(i){V.warn("‚ö†Ô∏è [DUAL-WRITE] Failed to update nested structure:",i)}}catch(i){Be("warnings.update",i)}},async updateFlatStructure(e,t,a){const r=h(K,`organizations/${a}/warnings/${e}`),i={...t,updatedAt:E(),organizationId:void 0};Object.keys(i).forEach(e=>{void 0===i[e]&&delete i[e]}),await A(r,i)},async delete(e){try{V.warn("warnings.delete not implemented - needs WarningService integration")}catch(t){Be("warnings.delete",t)}},async getEscalationRecommendation(e,t,a,r,i){try{return await $e.getEscalationRecommendation(e,t,a,r,i)}catch(n){Be("warnings.getEscalationRecommendation",n)}},async getActiveWarnings(e,t){try{return await $e.getActiveWarnings(e,t)}catch(a){Be("warnings.getActiveWarnings",a)}},async getStats(e){try{const t=await fe.getWarningsByOrganization(e);return{total:t.length,issued:t.filter(e=>"issued"===e.status).length,delivered:t.filter(e=>"delivered"===e.status).length,byLevel:{counselling:t.filter(e=>"counselling"===e.warningLevel).length,written_warning_1:t.filter(e=>"written_warning_1"===e.warningLevel).length,written_warning_2:t.filter(e=>"written_warning_2"===e.warningLevel).length,final_written_warning:t.filter(e=>"final_written_warning"===e.warningLevel).length,dismissal:t.filter(e=>"dismissal"===e.warningLevel).length}}}catch(t){Be("warnings.getStats",t)}},async archive(e,t,a){try{const r=h(K,`organizations/${t}/warnings/${e}`);await A(r,{isArchived:!0,archivedAt:E(),archiveReason:a,updatedAt:E()}),V.success(`Warning ${e} archived (reason: ${a})`)}catch(r){Be("warnings.archive",r)}},async getArchived(e){try{const t=await se.loadWarnings(e);return t.documents.filter(e=>!0===e.isArchived||"expired"===e.status||"overturned"===e.status)}catch(t){return Be("warnings.getArchived",t),[]}}},qe={async getAll(e,t=100){try{const[a,r]=await Promise.all([se.loadEmployees(e,{pageSize:t,orderField:"profile.lastName",orderDirection:"asc"}),se.loadWarnings(e)]),i=a.documents,n=r.documents,o=new Map,s=new Date;n.forEach(e=>{try{let t=null;e.expiryDate&&("function"==typeof e.expiryDate.toDate?t=e.expiryDate.toDate():e.expiryDate instanceof Date?t=e.expiryDate:"string"!=typeof e.expiryDate&&"number"!=typeof e.expiryDate||(t=new Date(e.expiryDate)));if(e.isActive&&(!t||!isNaN(t.getTime())&&t>s)&&e.employeeId){const t=o.get(e.employeeId)||0;o.set(e.employeeId,t+1)}}catch(t){V.warn(`‚ö†Ô∏è [WARNING COUNT] Error processing warning ${e.id}:`,t)}});const c=i.map(e=>{const t=o.get(e.id)||0;return{...e,disciplinaryRecord:{...e.disciplinaryRecord,activeWarnings:t,totalWarnings:e.disciplinaryRecord?.totalWarnings||t}}});return V.success(`üë• [OPTIMIZED] Loaded ${c.length} employees with warning counts (pageSize: ${t})`),c}catch(a){Be("employees.getAll",a)}},async getById(e,t){try{return await se.getEmployeeById(e,t)}catch(a){Be("employees.getById",a)}},async create(e){try{return(await se.saveEmployee(e,e.organizationId)).id}catch(t){Be("employees.create",t)}},async update(e,t,a){try{const r=await se.getEmployeeById(e,t);if(!r)throw new Error("Employee not found");const i={...r,...a};await se.saveEmployee(i,t)}catch(r){Be("employees.update",r)}},async delete(e,t){try{await se.archiveEmployee(e,t)}catch(a){Be("employees.delete",a)}},async bulkCreate(e,t){try{return(await se.bulkCreateEmployees(e,t)).success>0?["bulk-success"]:[]}catch(a){Be("employees.bulkCreate",a)}},async search(e,t){try{const a=(await se.loadEmployees(e)).documents,r=t.toLowerCase();return a.filter(e=>e.profile.firstName.toLowerCase().includes(r)||e.profile.lastName.toLowerCase().includes(r)||e.profile.employeeNumber.toLowerCase().includes(r)||e.profile.email.toLowerCase().includes(r))}catch(a){Be("employees.search",a)}},async getByManager(e,t){try{const a=De.generateOrgKey(t,"employees","manager",e);return await De.getOrFetch(a,async()=>{const a=await ne.queryDocuments(t,"employees",[S("employment.managerIds","array-contains",e),S("isActive","==",!0)],{pageSize:50,orderField:"profile.lastName",orderDirection:"asc"});return V.success(`üë• [OPTIMIZED] Loaded ${a.documents.length} employees for manager ${e}`),a.documents})}catch(a){Be("employees.getByManager",a)}},async generateNextEmployeeNumber(e,t="EMP001",a="",r=1){try{const i=await se.loadEmployees(e),n=i.documents.map(e=>e.profile?.employeeNumber).filter(e=>e&&"string"==typeof e);let o=r-1;n.forEach(e=>{const t=e.match(/(\d+)$/);if(t){const e=parseInt(t[1],10);e>o&&(o=e)}});const s=o+1;switch(t){case"EMP001":default:return`EMP${s.toString().padStart(3,"0")}`;case"E001":return`E${s.toString().padStart(3,"0")}`;case"001":return s.toString().padStart(3,"0");case"custom":return`${a}${s.toString().padStart(3,"0")}`}}catch(i){Be("employees.generateNextEmployeeNumber",i)}},async validateEmployeeNumber(e,t,a){try{const r=(await se.loadEmployees(e)).documents;if(!r.find(e=>e.profile?.employeeNumber===t&&e.id!==a))return{isAvailable:!0};const i=[],n=t.match(/(\d+)$/),o=t.replace(/(\d+)$/,"");if(n){const e=parseInt(n[1],10);for(let t=1;t<=3;t++){const a=`${o}${(e+t).toString().padStart(n[1].length,"0")}`;r.some(e=>e.profile?.employeeNumber===a)||i.push(a)}}return{isAvailable:!1,suggestions:i.slice(0,3)}}catch(r){Be("employees.validateEmployeeNumber",r)}},async archive(t,a,r){try{const{EmployeeLifecycleService:i}=await e(async()=>{const{EmployeeLifecycleService:e}=await import("./EmployeeLifecycleService-rnUWPbok.js");return{EmployeeLifecycleService:e}},__vite__mapDeps([0,1,2,3,4]));await i.archiveEmployee(t,a,r)}catch(i){Be("employees.archive",i)}},async restore(t,a,r){try{const{EmployeeLifecycleService:i}=await e(async()=>{const{EmployeeLifecycleService:e}=await import("./EmployeeLifecycleService-rnUWPbok.js");return{EmployeeLifecycleService:e}},__vite__mapDeps([0,1,2,3,4]));await i.restoreEmployee(t,a,r)}catch(i){Be("employees.restore",i)}},async getEligibleForDeletion(t){try{const{EmployeeLifecycleService:a}=await e(async()=>{const{EmployeeLifecycleService:e}=await import("./EmployeeLifecycleService-rnUWPbok.js");return{EmployeeLifecycleService:e}},__vite__mapDeps([0,1,2,3,4]));return await a.getEmployeesEligibleForDeletion(t)}catch(a){Be("employees.getEligibleForDeletion",a)}},async getLifecycleStats(t){try{const{EmployeeLifecycleService:a}=await e(async()=>{const{EmployeeLifecycleService:e}=await import("./EmployeeLifecycleService-rnUWPbok.js");return{EmployeeLifecycleService:e}},__vite__mapDeps([0,1,2,3,4]));return await a.getLifecycleStats(t)}catch(a){Be("employees.getLifecycleStats",a)}},async getArchived(e){try{return(await se.loadArchivedEmployees(e)).documents}catch(t){Be("employees.getArchived",t)}},async getAllWarningsForEmployee(e,t){try{return await se.getAllWarningsForEmployee(e,t)}catch(a){Be("employees.getAllWarningsForEmployee",a)}}},Ge={async getById(e){try{return await fe.getOrganization(e)}catch(t){Be("organizations.getById",t)}},async update(e,t){try{throw new Error("Organization updates not implemented in DataServiceV2")}catch(a){Be("organizations.update",a)}},async getCategories(e){try{return await se.getWarningCategories(e)}catch(t){Be("organizations.getCategories",t)}}},Ke={getUniversal:()=>xe,getById:e=>Ie(e)||null,getEscalationPath:e=>Ce(e),getNextLevel:(e,t)=>function(e,t){const a=Ie(e);if(!a)return null;const r=a.escalationPath.indexOf(t);return-1===r||r===a.escalationPath.length-1?null:a.escalationPath[r+1]}(e,t)||"verbal"},Ze={async getAll(t,a){try{const{collection:r,query:i,where:n,orderBy:o,getDocs:s}=await e(async()=>{const{collection:e,query:t,where:a,orderBy:r,getDocs:i}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Y);return{collection:e,query:t,where:a,orderBy:r,getDocs:i}},[]),c=r(K,"organizations",t,"recognitions"),l=[];a?.employeeId&&l.push(n("employeeId","==",a.employeeId)),a?.recognitionType&&l.push(n("recognitionType","==",a.recognitionType)),a?.departmentId&&l.push(n("departmentId","==",a.departmentId)),l.push(o("recognitionDate","desc"));const d=i(c,...l),u=await s(d),g=[];return u.forEach(e=>{g.push({id:e.id,...e.data()})}),V.success(`Loaded ${g.length} recognitions`),g}catch(r){Be("recognitions.getAll",r)}},async getById(t,a){try{const{doc:r,getDoc:i}=await e(async()=>{const{doc:e,getDoc:t}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Y);return{doc:e,getDoc:t}},[]),n=r(K,"organizations",t,"recognitions",a),o=await i(n);if(!o.exists())throw new Error("Recognition not found");return{id:o.id,...o.data()}}catch(r){Be("recognitions.getById",r)}},async create(t,a){try{const{collection:r,addDoc:i,serverTimestamp:n}=await e(async()=>{const{collection:e,addDoc:t,serverTimestamp:a}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Y);return{collection:e,addDoc:t,serverTimestamp:a}},[]),o=r(K,"organizations",t,"recognitions"),s=He({...a,createdAt:n(),updatedAt:n()}),c=await i(o,s);return V.success("Recognition created successfully",{id:c.id}),c.id}catch(r){Be("recognitions.create",r)}},async update(e,t,a){try{const r=He({...a,updatedAt:E()}),i=h(K,"organizations",e,"recognitions",t);await A(i,r),V.success("Recognition updated successfully",{id:t})}catch(r){Be("recognitions.update",r)}},async delete(t,a){try{const{doc:r,deleteDoc:i}=await e(async()=>{const{doc:e,deleteDoc:t}=await import("./firebase-vendor-BIBOIkWK.js").then(e=>e.Y);return{doc:e,deleteDoc:t}},[]),n=r(K,"organizations",t,"recognitions",a);await i(n),V.success("Recognition deleted successfully",{id:a})}catch(r){Be("recognitions.delete",r)}},async generateCertificate(e,t){try{throw new Error("Certificate generation not yet implemented")}catch(a){Be("recognitions.generateCertificate",a)}}},Ye={async loadDashboardData(e,t){try{const a=Date.now(),[r,i,n]=await Promise.all([qe.getByManager(t,e),Promise.resolve([]),Promise.resolve({})]),o=Date.now()-a;return V.success(`üöÄ [BATCH] Dashboard data loaded in ${o}ms (employees: ${r.length})`),{employees:r,followUps:i,stats:n,loadTime:o}}catch(a){throw Be("batch.loadDashboardData",a),a}},async loadOrganizationSetup(e){try{const t=Date.now(),a=De.generateOrgKey(e,"organization"),r=De.generateOrgKey(e,"categories"),i=De.generateOrgKey(e,"settings"),[n,o,s]=await Promise.all([De.getOrFetch(a,()=>fe.getOrganization(e)),De.getOrFetch(r,()=>se.getWarningCategories(e)),De.getOrFetch(i,()=>Promise.resolve({}))]),c=Date.now()-t;return V.success(`üöÄ [BATCH] Organization setup loaded in ${c}ms`),{organization:n,categories:o,settings:s,loadTime:c}}catch(t){throw Be("batch.loadOrganizationSetup",t),t}}},Qe={warnings:Ve,employees:qe,organizations:Ge,categories:Ke,recognitions:Ze,batch:Ye,reports:{async getAll(e){try{return[]}catch(t){Be("reports.getAll",t)}}},analytics:{async getDashboardMetrics(e){try{return{complianceScore:94,costPerEmployee:4250,riskScore:12}}catch(t){Be("analytics.getDashboardMetrics",t)}}}},Je=r.memo(({children:e,className:t="",style:r,hover:i=!1,padding:n="md",shadow:o="md",onClick:s})=>{const c={sm:"var(--shadow-sm)",md:"var(--shadow)",lg:"var(--shadow-lg)",xl:"var(--shadow-xl)"},l=a.useMemo(()=>({backgroundColor:"var(--color-card-background)",border:"1px solid var(--color-card-border)",boxShadow:c[o],transition:"all 0.2s ease",...r}),[o,r]),d=a.useCallback(e=>{i&&(e.currentTarget.style.transform="translateY(-2px)",e.currentTarget.style.boxShadow=c.lg)},[i]),u=a.useCallback(e=>{i&&(e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow=c[o])},[i,o]);return H.jsx("div",{className:`rounded-lg ${{none:"",sm:"p-3",md:"p-4",lg:"p-6"}[n]} ${s?"cursor-pointer":""} ${t}`,style:l,onClick:s,onMouseEnter:d,onMouseLeave:u,children:e})});Je.displayName="ThemedCard";const Xe=r.memo(({icon:e,title:t,subtitle:a,rightContent:r,className:i=""})=>H.jsxs("div",{className:`flex items-center justify-between ${i}`,children:[H.jsxs("div",{className:"flex items-center gap-3",children:[H.jsx(e,{className:"w-4 h-4",style:{color:"var(--color-primary)"}}),H.jsxs("div",{children:[H.jsx("h3",{className:"text-base font-semibold",style:{color:"var(--color-text)"},children:t}),a&&H.jsx("p",{className:"text-xs",style:{color:"var(--color-text-secondary)"},children:a})]})]}),r&&H.jsx("div",{className:"flex items-center gap-2",children:r})]}));Xe.displayName="ThemedSectionHeader";const et=r.memo(({type:e="text",label:t,value:r,onChange:i,placeholder:n,error:o,icon:s,required:c=!1,disabled:l=!1,options:d,className:u=""})=>{const g=a.useMemo(()=>({backgroundColor:o?"var(--color-alert-error-bg)":"var(--color-input-background)",borderColor:o?"var(--color-alert-error-border)":"var(--color-input-border)",color:"var(--color-text)"}),[o]),m=a.useCallback(e=>{i(e.target.value)},[i]);return H.jsxs("div",{className:`space-y-2 ${u}`,children:[H.jsxs("label",{className:"block text-xs font-medium",style:{color:"var(--color-text-secondary)"},children:[s&&H.jsx(s,{className:"w-3 h-3 inline mr-1"}),t," ",c&&H.jsx("span",{style:{color:"var(--color-error)"},children:"*"})]}),(()=>{const a={value:r,onChange:m,placeholder:n,disabled:l,className:"w-full h-11 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm "+(l?"opacity-50 cursor-not-allowed":""),style:g};return"textarea"===e?H.jsx("textarea",{...a,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm min-h-[88px] resize-vertical "+(l?"opacity-50 cursor-not-allowed":"")}):"select"===e&&d?H.jsxs("select",{...a,children:[H.jsx("option",{value:"",children:n||`Select ${t.toLowerCase()}...`}),d.map(e=>H.jsx("option",{value:e.value,children:e.label},e.value))]}):H.jsx("input",{...a,type:e})})(),o&&H.jsxs("div",{className:"flex items-center gap-1 text-xs",style:{color:"var(--color-error)"},children:[H.jsx("svg",{className:"w-3 h-3",viewBox:"0 0 20 20",fill:"currentColor",children:H.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),o]})]})});et.displayName="ThemedFormInput";const tt=r.memo(({children:e,variant:t="default",size:r="sm",className:i=""})=>{const n=a.useMemo(()=>{switch(t){case"primary":return{backgroundColor:"var(--color-badge-primary)",color:"var(--color-badge-primary-text)"};case"success":return{backgroundColor:"var(--color-badge-success)",color:"var(--color-badge-success-text)"};case"warning":return{backgroundColor:"var(--color-badge-warning)",color:"var(--color-badge-warning-text)"};case"error":return{backgroundColor:"var(--color-badge-error)",color:"var(--color-badge-error-text)"};default:return{backgroundColor:"var(--color-badge-default)",color:"var(--color-badge-default-text)"}}},[t]);return H.jsx("span",{className:`inline-flex items-center ${{sm:"px-2 py-0.5 text-xs",md:"px-3 py-1 text-sm"}[r]} font-medium rounded-full ${i}`,style:n,children:e})});tt.displayName="ThemedBadge";const at=r.memo(({children:e,variant:t="info",className:r="",onClose:i})=>{const n=a.useMemo(()=>{switch(t){case"success":return{backgroundColor:"var(--color-alert-success-bg)",borderColor:"var(--color-alert-success-border)",color:"var(--color-alert-success-text)"};case"warning":return{backgroundColor:"var(--color-alert-warning-bg)",borderColor:"var(--color-alert-warning-border)",color:"var(--color-alert-warning-text)"};case"error":return{backgroundColor:"var(--color-alert-error-bg)",borderColor:"var(--color-alert-error-border)",color:"var(--color-alert-error-text)"};default:return{backgroundColor:"var(--color-alert-info-bg)",borderColor:"var(--color-alert-info-border)",color:"var(--color-alert-info-text)"}}},[t]);return H.jsx("div",{className:`p-4 rounded-lg border ${r}`,style:{backgroundColor:n.backgroundColor,borderColor:n.borderColor,color:n.color},children:H.jsxs("div",{className:"flex justify-between items-start",children:[H.jsx("div",{className:"flex-1",children:e}),i&&H.jsx("button",{onClick:i,className:"ml-3 text-lg leading-none opacity-60 hover:opacity-100 transition-opacity",style:{color:n.color},children:"√ó"})]})})});at.displayName="ThemedAlert";const rt=r.memo(({variant:e="primary",size:t="md",fullWidth:r=!1,className:i="",children:n,style:o,icon:s,onMouseEnter:c,onMouseLeave:l,...d})=>{const u=a.useMemo(()=>(e=>{switch(e){case"primary":default:return{backgroundColor:"var(--color-primary)",color:"var(--color-text-inverse)",border:"1px solid var(--color-primary)",hoverColor:"var(--color-primary-hover)"};case"secondary":return{backgroundColor:"var(--color-secondary)",color:"var(--color-text-inverse)",border:"1px solid var(--color-secondary)",hoverColor:"var(--color-secondary-hover)"};case"accent":return{backgroundColor:"var(--color-accent)",color:"var(--color-text-inverse)",border:"1px solid var(--color-accent)",hoverColor:"var(--color-accent-hover)"};case"ghost":return{backgroundColor:"var(--color-btn-ghost)",color:"var(--color-text)",border:"1px solid transparent",hoverColor:"var(--color-btn-ghost-hover)"};case"outline":return{backgroundColor:"var(--color-btn-outline)",color:"var(--color-text)",border:"1px solid var(--color-btn-outline-border)",hoverColor:"var(--color-btn-outline-hover)"};case"danger":return{backgroundColor:"var(--color-error)",color:"var(--color-text-inverse)",border:"1px solid var(--color-error)",hoverColor:"var(--color-error)"}}})(e),[e]),g=a.useCallback(t=>{t.currentTarget.style.backgroundColor=u.hoverColor,"danger"===e&&(t.currentTarget.style.opacity="0.9"),c?.(t)},[e,u,c]),m=a.useCallback(e=>{e.currentTarget.style.backgroundColor=u.backgroundColor,e.currentTarget.style.opacity="1",l?.(e)},[u,l]);return H.jsxs("button",{className:`${{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[t]} font-medium rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 ${r?"w-full":""} ${i}`,style:{backgroundColor:u.backgroundColor,color:u.color,border:u.border,boxShadow:"ghost"!==e&&"outline"!==e?"var(--shadow-sm)":"none",focusRingColor:"var(--color-primary)",...o},onMouseEnter:g,onMouseLeave:m,...d,children:[s&&H.jsx(s,{className:"mr-2"}),n]})});rt.displayName="ThemedButton";const it=({role:e,skipData:t=[]}={})=>{const{user:r}=ve(),{organization:i,categories:n,loading:o}=Ae(),[s,c]=a.useState({organization:null,categories:[],user:null,employees:[],followUps:[],permissions:{},warnings:[],reports:[],teams:[],metrics:{},loading:{overall:!0,employees:!1,followUps:!1,permissions:!1,warnings:!1,reports:!1,teams:!1,metrics:!1},error:null}),l=a.useRef(!1),d=a.useRef(null),u=a.useCallback(e=>{const a={core:["organization","categories","permissions"],hod:["employees","followUps"],hr:["employees","followUps","warnings","reports","metrics"],executive_management:["employees","teams","reports","metrics"],super_admin:["employees","warnings","reports","metrics","teams"]};return[...a.core,...a[e]||[]].filter(e=>!t.includes(e))},[t]),g=a.useCallback(async()=>{const t=i?.id||r?.organizationId;if(!t||!r?.id||l.current)return;const a=`${t}-${r.id}-${e||r.role}`;if(d.current!==a){l.current=!0;try{const o=e||r.role||"hod",s=u(o);c(e=>({...e,organization:i||e.organization,categories:n||e.categories||[],user:r,loading:{overall:!1,employees:s.includes("employees"),followUps:s.includes("followUps"),permissions:s.includes("permissions"),warnings:s.includes("warnings"),reports:s.includes("reports"),teams:s.includes("teams"),metrics:s.includes("metrics")},error:null}));Date.now();const l=(e,t)=>{c(a=>({...a,[e]:t,loading:{...a.loading,[e]:!1}}))};if(s.includes("permissions")&&De.getOrFetch(`permissions:${r.id}:${t}`,()=>Promise.resolve({})).then(e=>l("permissions",e||{})).catch(e=>{V.error("‚ùå Failed to load permissions:",e),l("permissions",{})}),s.includes("employees")){const e="object"==typeof r.role&&r.role?.id?r.role.id:r.role||o,a="hr"===e||"executive_management"===e||"hr-manager"===e||"executive-management"===e,i=a?De.generateOrgKey(t,"employees:all"):De.generateOrgKey(t,`employees:manager:${r.id}`);De.getOrFetch(i,async()=>{const e=a?await Qe.employees.getAll(t):await Qe.employees.getByManager(r.id,t);return e.length,e}).then(e=>l("employees",Array.isArray(e)?e:[])).catch(e=>{V.error("‚ùå Failed to load employees:",e),l("employees",[])})}s.includes("followUps")&&De.getOrFetch(`followups:${r.id}:${t}`,()=>Promise.resolve([])).then(e=>l("followUps",Array.isArray(e)?e:[])).catch(e=>{V.error("‚ùå Failed to load followUps:",e),l("followUps",[])}),s.includes("warnings")&&De.getOrFetch(De.generateOrgKey(t,"warnings"),()=>Qe.warnings.getAll(t)).then(e=>l("warnings",Array.isArray(e)?e:[])).catch(e=>{V.error("‚ùå Failed to load warnings:",e),l("warnings",[])}),s.includes("reports")&&De.getOrFetch(De.generateOrgKey(t,"reports"),()=>Qe.reports.getAll(t)).then(e=>l("reports",Array.isArray(e)?e:[])).catch(e=>{V.error("‚ùå Failed to load reports:",e),l("reports",[])}),s.includes("teams")&&De.getOrFetch(De.generateOrgKey(t,"teams"),()=>se.getAllEmployees(t)).then(e=>l("teams",Array.isArray(e)?e:[])).catch(e=>{V.error("‚ùå Failed to load teams:",e),l("teams",[])}),s.includes("metrics")&&De.getOrFetch(De.generateOrgKey(t,"metrics"),()=>Qe.analytics.getDashboardMetrics(t)).then(e=>l("metrics",e||{})).catch(e=>{V.error("‚ùå Failed to load metrics:",e),l("metrics",{})}),d.current=a,Date.now()}catch(o){V.error("‚ùå [DashboardData] Failed to initialize progressive loading:",o),c(e=>({...e,loading:{overall:!1,employees:!1,followUps:!1,permissions:!1,warnings:!1,reports:!1,teams:!1,metrics:!1},error:o instanceof Error?o.message:"Failed to load dashboard data"}))}finally{l.current=!1}}},[i,r,n,e,u]),m=a.useCallback(()=>{d.current=null,De.clearByPrefix(`org:${i?.id}:`),g()},[i?.id]);return a.useEffect(()=>{r?.id&&(i?.id||r.organizationId)&&g()},[r?.id,i?.id,r?.organizationId]),{...s,refreshData:m,isReady:!s.loading.overall&&!!i&&!!r}},nt={success:"linear-gradient(135deg, var(--color-success), var(--color-success))",warning:"linear-gradient(135deg, var(--color-warning), var(--color-warning))",error:"linear-gradient(135deg, var(--color-error), var(--color-error))",primary:"linear-gradient(135deg, var(--color-primary), var(--color-primary))",accent:"linear-gradient(135deg, var(--color-accent), var(--color-accent))",info:"linear-gradient(135deg, var(--color-info), var(--color-info))"},ot=a.memo(({metrics:e,tabs:t,activeTab:a,onTabChange:r,loading:i=!1,error:n=null,middleSection:o,bottomSection:s,className:c=""})=>Se(768)?H.jsxs("div",{className:c,children:[H.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-3 mb-6",children:e.map(e=>H.jsx(Je,{padding:"sm",shadow:"lg",hover:!!e.onClick,onClick:e.onClick,className:(e.onClick?"cursor-pointer":"")+" transition-all duration-200 active:scale-95",style:{background:nt[e.color],color:"var(--color-text-inverse)",minHeight:"80px",willChange:"transform",opacity:e.loading?.7:1},children:H.jsxs("div",{className:"flex items-center gap-3",children:[H.jsx(e.icon,{className:"w-8 h-8",style:{opacity:.7}}),H.jsxs("div",{children:[H.jsx("div",{className:"text-sm",style:{opacity:.8},children:e.label}),e.loading?H.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-current mt-1"}):H.jsxs(H.Fragment,{children:[H.jsx("div",{className:"text-2xl font-bold",children:e.value}),e.subtext&&H.jsx("div",{className:"text-xs mt-0.5",style:{opacity:.8},children:e.subtext})]})]})]})},e.id))}),n&&H.jsx(at,{variant:"error",className:"mb-4",children:H.jsxs("div",{className:"text-sm",children:["Failed to load dashboard data: ",n]})}),H.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:[H.jsx("div",{className:"border-b border-gray-200",children:H.jsx("nav",{className:"flex space-x-6 px-4",children:t.map(e=>H.jsxs("button",{onClick:()=>r(e.id),className:"flex items-center gap-2 py-3 px-1 border-b-2 text-sm font-medium transition-colors relative "+(a===e.id?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[H.jsx(e.icon,{className:"w-4 h-4"}),e.label,(e.badgeCount??0)>0&&H.jsx("span",{className:"bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center ml-1",children:e.badgeCount})]},e.id))})}),H.jsx("div",{className:"p-4",children:t.map(e=>a!==e.id?null:H.jsx("div",{className:"hidden lg:block",children:e.content},`content-${e.id}`))})]}),s&&H.jsx("div",{className:"mt-6",children:s})]}):H.jsxs("div",{className:`space-y-6 ${c}`,children:[H.jsx("div",{className:"grid grid-cols-2 gap-2 mb-3",children:e.map(e=>H.jsx(Je,{padding:"sm",shadow:"lg",hover:!!e.onClick,onClick:e.onClick,className:(e.onClick?"cursor-pointer":"")+" transition-all duration-200 active:scale-95",style:{background:nt[e.color],color:"var(--color-text-inverse)",minHeight:"80px",willChange:"transform",opacity:e.loading?.7:1},children:H.jsxs("div",{className:"flex flex-col items-center gap-1.5 py-1",children:[H.jsx(e.icon,{className:"w-5 h-5"}),H.jsx("span",{className:"font-medium text-xs text-center leading-tight",children:e.label}),e.loading?H.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-current"}):H.jsx("span",{className:"text-lg font-bold",children:e.value})]})},e.id))}),o&&H.jsx("div",{className:"mb-3",children:o}),H.jsx("div",{className:"space-y-3",children:t.map(e=>H.jsx(Je,{padding:"md",shadow:"sm",hover:!0,onClick:()=>r(e.id),className:"cursor-pointer transition-all duration-200 active:scale-95",style:{minHeight:"64px",willChange:"transform"},children:H.jsxs("div",{className:"flex items-center justify-between",children:[H.jsxs("div",{className:"flex items-center gap-3",children:[H.jsx(e.icon,{className:"w-5 h-5",style:{color:"var(--color-primary)"}}),H.jsx("span",{className:"font-semibold",style:{color:"var(--color-text)"},children:e.label})]}),H.jsxs("div",{className:"flex items-center gap-2",children:[(e.badgeCount??0)>0&&H.jsx("span",{className:"bg-red-500 text-white text-xs rounded-full px-2 py-0.5 font-medium",children:e.badgeCount}),H.jsx($,{className:"w-5 h-5",style:{color:"var(--color-text-secondary)"}})]})]})},e.id))}),t.map(e=>a!==e.id?null:H.jsx("div",{className:"fixed inset-0 backdrop-blur-sm flex items-center justify-center z-50 p-4",style:{backgroundColor:"var(--color-overlay)"},children:H.jsxs(Je,{padding:"none",className:"max-w-7xl w-full max-h-[90vh] flex flex-col overflow-hidden",shadow:"xl",children:[H.jsxs("div",{className:"flex items-center justify-between p-4 flex-shrink-0",style:{borderBottom:"1px solid var(--color-border)"},children:[H.jsx("h2",{className:"text-lg font-bold",style:{color:"var(--color-text)"},children:e.label}),H.jsx(rt,{variant:"ghost",size:"sm",onClick:()=>r(null),children:"√ó"})]}),H.jsx("div",{className:"flex-1 overflow-y-auto p-4 min-h-0",children:e.mobileContent||e.content})]})},`modal-${e.id}`)),s&&H.jsx("div",{className:"mt-6",children:s})]}));ot.displayName="DashboardShell";const st=r.lazy(()=>e(()=>import("./OrganizationManagementV2-6W0PK7yr.js"),__vite__mapDeps([5,2,6,1,3,4,7,8])).then(e=>({default:e.OrganizationManagementV2}))),ct=r.lazy(()=>e(()=>import("./OverviewCard-D4wI38Zf.js"),__vite__mapDeps([9,2,4,1,3])).then(e=>({default:e.WarningsOverviewCard}))),lt=r.lazy(()=>e(()=>import("./EmployeeManagement-PJFEvAf-.js"),__vite__mapDeps([10,2,7,6,1,3,4,8,11,12])).then(e=>({default:e.EmployeeManagement}))),dt=r.lazy(()=>e(()=>import("./dashboard-router-DriKLXjX.js").then(e=>e.O),__vite__mapDeps([7,2,6,1,3,4,8])).then(e=>({default:e.OrganizationCategoriesViewer}))),ut=r.lazy(()=>e(()=>import("./DepartmentManagement-DUiAX536.js"),__vite__mapDeps([13,1,2,7,6,3,4,8])).then(e=>({default:e.DepartmentManagement}))),gt=r.lazy(()=>e(()=>import("./FinalWarningsWatchList-FlCXsP7W.js"),__vite__mapDeps([14,2,4,1,3])).then(e=>({default:e.FinalWarningsWatchList}))),mt=()=>H.jsxs("div",{className:"animate-pulse space-y-4 p-4",children:[H.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),H.jsxs("div",{className:"space-y-3",children:[H.jsx("div",{className:"h-4 bg-gray-200 rounded w-full"}),H.jsx("div",{className:"h-4 bg-gray-200 rounded w-5/6"}),H.jsx("div",{className:"h-4 bg-gray-200 rounded w-4/6"})]})]}),pt=a.memo(({className:e=""})=>{const{organization:t}=Ae(),[i,n]=a.useState("organization"),{employees:o,warnings:s,metrics:c,loading:l,error:d,refreshData:u}=it({role:"executive_management"}),g=a.useMemo(()=>({totalEmployees:o?.length||0,activeWarnings:s?.filter(e=>"delivered"!==e.status&&"expired"!==e.status)?.length||0,undeliveredWarnings:s?.filter(e=>!e.delivered&&"expired"!==e.status)?.length||0,highSeverityWarnings:s?.filter(e=>("high"===e.severity||"gross_misconduct"===e.category?.severity)&&"expired"!==e.status)?.length||0}),[o,s]),m=a.useMemo(()=>[{id:"total-employees",label:"Total Employees",value:g.totalEmployees,icon:k,color:"success",onClick:()=>n("employees")},{id:"active-warnings",label:"Active Warnings",value:g.activeWarnings,subtext:`${g.undeliveredWarnings} undelivered`,icon:P,color:"warning",onClick:()=>n("warnings")},{id:"high-priority",label:"High Priority",value:g.highSeverityWarnings,subtext:"Critical cases",icon:L,color:"error",onClick:()=>n("warnings")},{id:"departments",label:"Departments",value:c?.departmentCount||0,icon:W,color:"primary",onClick:()=>n("departments")}],[g,c]),p=a.useMemo(()=>[{id:"organization",label:"Organization",icon:W,content:H.jsx("div",{className:"space-y-4",children:H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(st,{onSwitchToDepartments:()=>n("departments")})})})},{id:"departments",label:"Departments",icon:W,content:t?H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(ut,{isOpen:!0,onClose:()=>n("organization"),organizationId:t.id,inline:!0})}):null},{id:"categories",label:"Warning Categories",icon:F,content:H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(dt,{onClose:()=>n("organization"),inline:!0})})},{id:"employees",label:"Employees",icon:k,content:H.jsx("div",{className:"space-y-4",children:H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(lt,{onDataChange:u,inline:!0,readOnly:!0})})})},{id:"warnings",label:"Warnings",icon:L,content:H.jsxs("div",{className:"space-y-3",children:[H.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-2",children:[H.jsx("div",{className:"bg-orange-50 rounded-lg p-2.5 border border-orange-200",children:H.jsxs("div",{className:"flex items-center gap-2",children:[H.jsx(P,{className:"w-5 h-5 text-orange-600 flex-shrink-0"}),H.jsxs("div",{children:[H.jsx("div",{className:"text-lg font-bold text-orange-600",children:g.undeliveredWarnings}),H.jsx("div",{className:"text-xs text-orange-700 font-medium",children:"Undelivered"})]})]})}),H.jsx("div",{className:"bg-red-50 rounded-lg p-2.5 border border-red-200",children:H.jsxs("div",{className:"flex items-center gap-2",children:[H.jsx(L,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),H.jsxs("div",{children:[H.jsx("div",{className:"text-lg font-bold text-red-600",children:g.highSeverityWarnings}),H.jsx("div",{className:"text-xs text-red-700 font-medium",children:"High Severity"})]})]})}),H.jsx("div",{className:"bg-blue-50 rounded-lg p-2.5 border border-blue-200",children:H.jsxs("div",{className:"flex items-center gap-2",children:[H.jsx(L,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),H.jsxs("div",{children:[H.jsx("div",{className:"text-lg font-bold text-blue-600",children:g.activeWarnings}),H.jsx("div",{className:"text-xs text-blue-700 font-medium",children:"Total Active"})]})]})})]}),H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(ct,{userRole:"business-owner",variant:"executive"})})]})}],[g,t,u]);return H.jsx(ot,{metrics:m,tabs:p,activeTab:i,onTabChange:n,loading:l.overall,error:d,bottomSection:H.jsx(r.Suspense,{fallback:H.jsx(mt,{}),children:H.jsx(gt,{employees:o})}),className:e})});pt.displayName="ExecutiveManagementDashboardSection";const ht=Object.freeze(Object.defineProperty({__proto__:null,ExecutiveManagementDashboardSection:pt},Symbol.toStringTag,{value:"Module"}));export{Qe as A,Q as B,ae as C,ne as D,ie as E,te as F,oe as G,ce as H,ht as I,V as L,ke as N,Ee as O,se as S,rt as T,xe as U,Ae as a,it as b,ot as c,K as d,Se as e,Je as f,tt as g,Te as h,G as i,H as j,re as k,Y as l,le as m,q as n,at as o,We as p,je as q,be as r,Z as s,we as t,ve as u,Xe as v,Ce as w,ze as x,et as y,Ue as z};
